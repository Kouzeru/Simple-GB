<!DOCTYPE html><html><head><meta charset="utf-8"/><title>Simple JavaScript-GameboyEmulator</title></head>
	<body>
		<table id="MAIN"><tr><td id="disp" >
			<input type="checkbox" name="mblur" onchange="mblurenab()">Motion blur enable<br />
			<div id="cfr" style="white-space:pre"> </div><center>
			<canvas id="GBScr" width="160" height="144"></canvas><br />
			<select id="demolist"><option value="-1">Load *.GB through file</option></select>
			<table id="RUN"><tr>
			<td><button id="load" type="button" onmouseup="load()">Load</button>
			<input type="file" id="getfile" accept='.gb' onchange="gload()"></td>
			<td><button id="play" type="button" onmouseup="play()">Play</button></td>
			<td><button id="reset" type="button" onmouseup="reset()">Reset</button></td></tr></table><table><tr>
			<td><button id="load" type="button" onmouseup="load()">Load .sav</button>
			<input type="file" id="getfile" accept='.gb' onchange="sload()"></td>
			<td><button id="load" type="button" onmouseup="load()">Save .sav</button>
			<input type="file" id="getfile" accept='.gb' onchange="ssave()"></td></tr></table>
			.sav not yet implemented</center>
		</td><td><canvas id="BGScr" width="256" height="256"></canvas><br />
		<input type="checkbox" name="bgtiles" onchange="bgmapview()">View BG Map (performance impact)<br />
		</td><td id="Regs" style="white-space:pre">test</td></tr><tr><td>
		<table class="sndmode"><tbody>
			<tr><td><input type="radio" name="sndmode" value="No Sound">No Sound<br></td></tr>
			<tr><td><input type="radio" name="sndmode" value="MIDISynth">MIDI Synth<br></td>
				<td><input type="checkbox" name="madv" value="MIDIAdv">Series<br></td></tr>
			<tr><td><input type="radio" name="sndmode" value="Oscillator">Oscillator<br></td>
				<td><input type="checkbox" name="oscp" value="Oscwave">Varied<br></td></tr>
			<tr><td><input type="radio" name="sndmode" value="BufferSynch" checked>Buffer Synch<br></td>
				<td><input type="checkbox" name="bsgn" value="BSUseGain">UseRamp<br></td></tr>
			<tr><td><input type="radio" name="sndmode" value="SampleBuffer">Sample Buffer<br></td></tr>
		</table>No effect. Programmed later.
		</td>
		
		<td>
		<table class="palettes"><tr><td>
				<table class="viewpal" id="bgpalview"><tr><td></td><td></td><td></td><td></td></tr></table> GB Background/Window Colors
			</td></tr><tr><td>
				  <input class="inpal" name="bkgpalval" type="text" value="000000FF" onchange="setpal(0,0)" maxlength="8"/><input class="inpal" name="bkgpalval" type="text" value="000000AA" onchange="setpal(0,1)" maxlength="8"/><input class="inpal" name="bkgpalval" type="text" value="00000055" onchange="setpal(0,2)" maxlength="8"/><input class="inpal" name="bkgpalval" type="text" value="00000000" onchange="setpal(0,3)" maxlength="8"
				/></td></tr><tr><td>
				  <input class="inpal" name="winpalval" type="text" value="000000FF" onchange="setpal(1,0)" maxlength="8"/><input class="inpal" name="winpalval" type="text" value="000000AA" onchange="setpal(1,1)" maxlength="8"/><input class="inpal" name="winpalval" type="text" value="00000055" onchange="setpal(1,2)" maxlength="8"/><input class="inpal" name="winpalval" type="text" value="00000000" onchange="setpal(1,3)" maxlength="8"/>
			</td></tr><tr><td>
				<table class="viewpal" id="bgpalview"><tr><td></td><td></td><td></td><td></td></tr></table> GB Object 1/Object 2 Colors
			</td></tr><tr><td>
				  <input class="inpal" name="ob0palval" type="text" value="000000FF" onchange="setpal(2,0)" maxlength="8"/><input class="inpal" name="ob0palval" type="text" value="000000AA" onchange="setpal(2,1)" maxlength="8"/><input class="inpal" name="ob0palval" type="text" value="00000055" onchange="setpal(2,2)" maxlength="8"/><input class="inpal" name="ob0palval" type="text" value="00000000" onchange="setpal(2,3)" maxlength="8"
				/></td></tr><tr><td>
				  <input class="inpal" name="ob1palval" type="text" value="000000FF" onchange="setpal(3,0)" maxlength="8"/><input class="inpal" name="ob1palval" type="text" value="000000AA" onchange="setpal(3,1)" maxlength="8"/><input class="inpal" name="ob1palval" type="text" value="00000055" onchange="setpal(3,2)" maxlength="8"/><input class="inpal" name="ob1palval" type="text" value="00000000" onchange="setpal(3,3)" maxlength="8"/>
				</td>
		</tr></table></td><td>
		<div>AB-Pad = [A S] key <br />D-Pad = Arrow keys <br />Select = Space<br />Start = Return</div></td></table>
		
		
		
	<style>
	body {
		font-family: monospace
	}
	canvas {
		border: 1px solid black;
		background-color : #EEFFDD;
		image-rendering:pixelated
	}
	
	.inpal {
		font-family: monospace;
		border:0;font-size:1em;
		width:8ch;padding:0;color:black;
		text-shadow: 1px 1px white;
	}
	
	.viewpal, .palettes, .sndmode {
		border-collapse: collapse;
	}
	
	.sndmode > tbody > tr > td { padding : 0; }
	.palettes > tbody > tr > td { padding: 0; background-color : #EEFFDD; text-shadow: 1px 1px white; }
	
	#MAIN, #MAIN > tbody > tr > td {
		border: 1px solid black;
		border-collapse:none
	}
	
	#RUN > tbody > tr > td {
		width: 33.33%
	}
	#RUN {
		width: 100%
	}
	#disp {
		padding: 25px
	}
	#getfile {
		display:none
	}
	</style>
	<script src="data.js"></script>
	<script name="GBCore">	
	var	GB	=	function(GBscr,BGscr) {
				//  private Start
				var	_,$,__,$$,// Temporaries
					_$,$_,_O,    // Last MMU read
				//	Variable declarations
					A,         // 8-bit A Register
					B,         // 8-bit B Register
					C,         // 8-bit C Register
					D,         // 8-bit D Register
					E,         // 8-bit E Register
					F,         // 8-bit F Register
					H,         // 8-bit H Register
					L,         // 8-bit L Register
					PC,        // Program Counter
					SP,	       // Stack Pointer
					mbc={      // MBC registers
					tp:0,	   // MBC type
					md:0,	   // MBC model
					cs:0,      // CROM bank Select
					es:0,      // ERAM bank Select
					en:0},     // ERAM access
					ms,	       // Current Timer
					mt,        // Machine Timer
					mc,	       // Number of cycles
					bs,        // BIOS inaccessable
					vr,	       // VRAM inaccessable
					dma,	   // DMA transfer state
					ime,	   // Interrupt Enable
					ims,       // Pending Interrupt Enable
					csm,	   // CPU speed multiplier
					halt,      // CPU halt
					stop,      // CPU stop
					keys,	   // Keystate
					snd,	   // Sound
				//	Array declarations
					BIOS,   // BIOS              # 0x0000-0x00FF
				//	CROM,   // Catridge ROM      # 0x0000-0x7FFF
					VRAM,   // Video part of RAM # 0x8000-0x9FFF
					ERAM,   // External Work RAM # 0xA000-0xBFFF
					WRAM,   // Internal Work RAM # 0xC000-0xDFFF
					HRAM,   // High page of RAM  # 0xFE00-0xFFFF
				//	16-bit union registers. XY() to read, XY(N) to write
					AF=($=-1)=>($<0?A*256+F:(F=$&240,A=$>>8,$)),
					BC=($=-1)=>($<0?B*256+C:(C=$&255,B=$>>8,$)),
					DE=($=-1)=>($<0?D*256+E:(E=$&255,D=$>>8,$)),
					HL=($=-1)=>($<0?H*256+L:(L=$&255,H=$>>8,$)),
				//	Predefined data
					//gbpal=[[[0,0,0,255],[0,0,0,170],[0,0,0,86],[0,0,0,0]],
					//	   [[0,0,0,255],[0,0,0,170],[0,0,0,86],[0,0,0,0]],
					//	   [[0,0,0,255],[0,0,0,170],[0,0,0,86],[0,0,0,0]]],
					gbpal=[[[185,255,168,255],[126,178,122,255],[67,101,77,255],[8,24,32,255]],
						   [[248,240,120,255],[176,168,72,255],[104,104,58,255],[32,32,16,255]],
						   [[255,223,192,255],[202,148,128,255],[149,74,64,255],[96,0,0,255]],
						   [[192,211,255,255],[128,140,202,255],[64,70,149,255],[0,0,96,255]]],
				
					internalBiosRom=atob(
						'Mf7/ryH/nzLLfCD7ISb/DhE+gDLiDD7z4jI+d3c+/OBHEQQBIRCAGs2VAM2WABN7/jQg8xHYAAYIGhMiIwUg+T4Z6hCZIS+ZDgw9KAgyDSD5Lg8Y82c+ZFfg'+
						'Qj6R4EAEHgIODPBE/pAg+g0g9x0g8g4TJHweg/5iKAYewf5kIAZ74gw+h+LwQpDgQhUg0gUgTxYgGMtPBgTFyxEXwcsRFwUg9SIjIiPJzu1mZswNAAsDcwCD'+
						'AAwADQAIER+IiQAO3Mxu5t3d2Zm7u2djbg7szN3cmZ+7uTM+PEK5pbmlQjwhBAERqAAaE74g/iN9/jQg9QYZeIYjBSD7hiD+PgHgUA=='
						).split('').map(_=>_.charCodeAt(0)),
					internalCartRom=atob(
						'//////////////////////////////////////////////////////////////////////////9AGP3///////Xlw+cB////9eUhCMDwRP5QMA6G5h8mCm9+'+
						'1grgQ+Hx2a/gQzzg/+Hx2f//////////////////////////////////////////////////////////////////////////////////////////////////'+
						'/////////////////////////////////////////////////////////////////////////////////////////////////////wDDUAHO7WZmzA0ACwNz'+
						'AIMADAANAAgRH4iJAA7czG7m3d3Zmbu7Z2NuDuzM3dyZn7u5Mz5CR0JXRUxDT01FAAAAAAAAAAAAAAAAAAAAEHEX8zH+//BE/pAg+q/gQCEAgBEAIM23AyEA'+
						'wBEAIM23AyEQgAGZBBFIAc3PAyEAiAHhBREAAs3CAyGA/wEZBBEKAM3CAyEAmBHhB83lAyEAwQE9CBGgAM3CA81XBD7T4EA+G+BH4Eg+QOBJPgjgQT4D4P8+'+
						'AeoJwD4I4EKv4A/gQyEAwDbFIzanPgHqBcA+gOoKwPt2AAAY+8XVzSMEzTgDzYD/IQfANCrLP8s/dz5A4Emv4EP6CcDg/80ZAs2EAs3bAs1jAtHB4fHZAUDB'+
						'DAwMCuYDXw0NCpM4CgIMDAx5/qAg6sk+qAINCj0gBs0fAwwCDc0fA+Z/xgICDAzNHwPmAcaQAgx95g9f1gMw+xz2kAIMGMr6A8C3yCEKwMt/IBKmKAx+yz84'+
						'AnfJLX7uAiI2gMk2QMn6AsDuwObA+gPAKBJHIQDArn54IcsChzgQIyMg+cnLfyjq8CXuROAlyfUOEwYA+gTA7gHqBMAgBA4YBgIqgOIMKvaA4vEYzwoGQgZy'+
						'BokGsgbWBucGBgcBBcAKPQLAPgQCDhzy5mAoBMYg4skhBsA0fuYCT80fA3m3KAPLRcgWAHzmB4dfIcsCGT6A4Bo+QOAcDh0q4gwq9oDiyREAwBpnHBpvKTAC'+
						'y8V9y3woAu4BEh18Esn6AsBHPpTLcCACxhAhB5oiPCIsPpbLeCACxhAiPCI+nMtoIALGECGtmSI8Iiw8Ls0iPDI+mMtgIALGECGQmSI8Iiw8LrAiPDImwT54'+
						'y1ggAa8uAHcuBHc+YMtQIAGvLgh3Lgx3PhDLSCABry4Rdy4Vdz4oy0AgAa8uGXcuHXfJzd0DIh0g/BUg+cnN3QMKIgMdIPoVIPfJzd0DCiIiAx0g+RUg9sn1'+
						'e7coARTxyRoT/sAoFf7gKB4iGPMaRxMaT3gTIjwNIPsY5RpHExpPeBMiDSD8GNgaE/7/yP7zKNxAGP0+weBGPig9IP3JPiDgAPAA8ADwAPAAL+YPRz4Q4ADw'+
						'APAA8ADwAC/mD8s3sEf6AsCooOoDwHjqAsA+MOAAya/gJgAAAAA+gOAmPv/gJT534CSv4BDgHD5A4BHgFj6U4BLgFyGJBA4wKuIMef5AIPjJABEiM0RVZneI'+
						'maq7zN3u/39/f39/f39//////////+D+////////fwCAwODg8PDwAAADBw8fPz8f////////+Pz///////8fAIDA4PD4+Px/f39/f39/f+Dg4OD/////Pz8/'+
						'f////v/w8PDgwIAAgH9/f///////4ODAwICBgYEPAAAAAP////wAAAAA/Pz8f39/f39/f3/////g4ODg4P///z8fHx8fwODw8Pj4+Pj//////39/f4GBgYHA'+
						'wMDg/////wcHBw/8/Pz8/Pz8/H9/f39/f39/4P////////8//////////Pj48PDgwIAAPz8fDwcDAAD4////////Hz/////////4/Pz8+PDAAAAAfH5mfnxg'+
						'YAB8fmZ+fGZmAH5+YHxgfn4APn5AfgJ+fAB8fmZ8Zn58AGZmZmZmfjwAfn4YGBgYGAA8fmZmZn48AGZ2dm5uZmYAAAAAAAAAAwAHAA8AHwAfAAcAPwD/AP8A'+
						'+APwBPAF8ADgAPwA/wD/AB/gDwAPwA8AAAAAAAAAwADgAPAA+AD4AD8APwB/AH8AeAPwBPAF8ATwBfAE8AXwBAD4AAEAUgAAD8APAA/ADwAADwDAACUAAPwA'+
						'/AD+AP4AHuAPAA9ADwXwBfAE8AB4AH8AfwA/AD9SAFIAAQAAAATwBfAE8AXwJQBlAMAAAAAAD8APAA/AD0APQA8ADwAeAP4A/gD8APwAHwAfAA8ABwADAAAA'+
						'AAAABPAF8ATwAPgA/wD/AD8ABwAPwA8ADwAfAP8A/wD8AOAA+AD4APAA4ADAAAAAAAAAwMAAAAAAAAAAAAAAAAAAAPDw8PAAAAAAAAAAAAAAAAAAAwAPAB8A'+
						'PwB/AH8B/gL8AP8A/wD/AP8A/wD/AP8A/wB/HeIR7h3iBfod4gD/AH8A/tAvEO/QLxDv3CMA/wD+AH93iEK9co0S7XKNAP8AfwD+d4hSrWKdUq1SrQD/AP4A'+
						'AwAPAB8DPAd4BnkG+Qb5AMAA8AD4wDzgHmCeYJ9gnwb5B/gGeQZ5BjkAHwAPAANgn+AfYJ5gnmCcAPgA8ADAAAMADwAfBzgHeAZ5BvkH+ADAAPAA+IB8wD5A'+
						'vkC/gH8H+Ab5BnkHeAc4AB8ADwADgH9Av0C+wD6AfAD4APAAwMAAYeDzgAQA4PMBCODzAQTAAA/g84QEAODzCQjg8wkEwAAP4POIBADg8xEI4PMRBMAAD+Dz'+
						'jAQA4PMZCODzGQTAAFEhIiMkJAAlJicnKCkkwAAWJygAJyMkJ+D/eBiSQHggkmBgGJIAYCCSIGgQkgBwEJJAaCiSIHAokmAAAAAAAAAAAAAAAAAAAAAAAAAA'+
						'AAAAAAAAAAAAAAAAAAEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEB'+
						'AQEBAQEBAQEBAQEBAQEBAQEBAf//////////////////////////////////////////////////////////////////////////////////////////////'+
						'////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////'+
						'////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////'+
						'/////////////////////////////////////////////////////wABAQIDBAUHCAkLDA0ODw8PDw8ODQwLCQgHBQQDAgEB////////////////////////'
						).split('').map(_=>_.charCodeAt(0)),
					cartinfo={
						0x00:  "ROM ONLY",                0x13:  "MBC3+RAM+BATTERY",
						0x01:  "MBC1",                    0x15:  "MBC4",
						0x02:  "MBC1+RAM",                0x16:  "MBC4+RAM",
						0x03:  "MBC1+RAM+BATTERY",        0x17:  "MBC4+RAM+BATTERY",
						0x05:  "MBC2",                    0x19:  "MBC5",
						0x06:  "MBC2+BATTERY",            0x1A:  "MBC5+RAM",
						0x08:  "ROM+RAM",                 0x1B:  "MBC5+RAM+BATTERY",
						0x09:  "ROM+RAM+BATTERY",         0x1C:  "MBC5+RUMBLE",
						0x0B:  "MMM01",                   0x1D:  "MBC5+RUMBLE+RAM",
						0x0C:  "MMM01+RAM",               0x1E:  "MBC5+RUMBLE+RAM+BATTERY",
						0x0D:  "MMM01+RAM+BATTERY",       0xFC:  "POCKET CAMERA",
						0x0F:  "MBC3+TIMER+BATTERY",      0xFD:  "BANDAI TAMA5",
						0x10:  "MBC3+TIMER+RAM+BATTERY",  0xFE:  "HuC3",
						0x11:  "MBC3",                    0xFF:  "HuC1+RAM+BATTERY",
						0x12:  "MBC3+RAM"
					},
				
				// 	Predefined constructure
					Snd	=	function(){var ctx=new AudioContext(),n=0.125,p=-n,opt={},
							sqv=new Array(4),nwv=new Array(2),wvt=new Float32Array(32)
							sqv[0]=new Float32Array([n,n,n,n,n,n,n,n,n,n,n,n,n,n,p,p])
							sqv[1]=new Float32Array([p,p,n,n,n,n,n,n,n,n,n,n,n,n,p,p])
							sqv[2]=new Float32Array([p,p,n,n,n,n,n,n,n,n,p,p,p,p,p,p])
							sqv[3]=new Float32Array([n,n,p,p,p,p,p,p,p,p,p,p,p,p,n,n])
							nwv[0]=new Float32Array(1<<15);nwv[1]=new Float32Array(1<<15);
							//for(let i=0,k=1<<15;i<k;i++)nwv[0][i]=(Math.random()*2&1)/8     //Generation
							//for(let i=0,k=1<<7;i<k;i++)nwv[1][i]=(Math.random()*2&1)/8      //of Noise by
							//for(let i=1<<7,j=0,k=1<<15;i<k;i++,j++)nwv[1][i]=nwv[1][j]  //Randomization
							wvt=new Float32Array([n,n,n,n,n,n,n,n,n,n,n,n,n,n,n,n,p,p,p,p,p,p,p,p,p,p,p,p,p,p,p,p])
							for(let i=0,j=1,k=1<<15;i<k;i++,j=(j&1^1&j>>1)<<14|j>>1)nwv[0][i]=(j&1)*n*2-n;//LFSR
							for(let i=0,j=1,k=1<<15;i<k;i++,j=(j&1^1&j>>1)<<6|j>>1)nwv[1][i]=(j&1)*n*2-n; //Noise
							
							opt.sndMode="buffersynch";
							opt.useRamp=false;
							opt.enableA=true;
							opt.enableB=true;
							opt.enableC=true;
							opt.enableD=true;
							
						var	spl=ctx.createChannelSplitter(2),mrg=ctx.createChannelMerger(2),
							mgL=ctx.createGain(),mgR=ctx.createGain();mgL.gain.value=1;mgL.gain.value=1;
							spl.connect(mgL,0);spl.connect(mgR,1);mrg.connect(ctx.destination)
							mgR.connect(mrg,0,1);mgL.connect(mrg,0,0);
						var	Gnc	= function(_,$){ this.mt=mt;this.ct=this.ok=0;
							var gnd=ctx.createGain(),gn=gnd.gain,gnd2=ctx.createGain(),gn2=gnd2.gain,updbuf=1,
								pnd=ctx.createStereoPanner(),pn=pnd.pan,pgnd=ctx.createGain(),pgn=pgnd.gain,
								bf=ctx.createBuffer(1,$,32768),ID=_,wlen=0,pitch=1,
								recreateBfs=_=>{let x=ctx.createBufferSource(),y=ctx.currentTime;
									bf.copyToChannel(bfd,0,0);x.playbackRate.value=pitch;
									x.buffer=bf;if(this.con){x.connect(gnd)};x.loop=true;
									if(bfs){if(this.con){bfs.disconnect()};bfs.stop(y);delete bfs;}
									x.start(y);bfs=x;this.ok=1;updbuf=0},
								fosc=0,eswt=0,esws,fswt=0,fsws=0,fswh=0;
								gn.value=0;pn.value=0;pgnd.value=1;pgnd.connect(spl);
								gnd.connect(gnd2);gnd2.connect(pnd);pnd.connect(pgnd);
								
								this.lrso=(a,b)=>(pgnd.value=(a+b)/2,pn.value=a-b);
								this.play=(__,_$,$$)=>{var z=0,n=1,_=this.env,$=this.envs;
									bfs.playbackRate.value=pitch=__/2048;
									if(_$){ esws=eswt=parseInt(mt/16384)*16384;
										if(opt.useRamp){
											gn.cancelScheduledValues(ctx.currentTime);
											gn2.cancelScheduledValues(ctx.currentTime);}
										if(updbuf|!this.ok)recreateBfs()
											gn2.value=1;gn.value=_/15;
											$_=HRAM[0x110]
										if(opt.useRamp){if($)if($<0){
											gn.linearRampToValueAtTime(z,ctx.currentTime-(_*$/64))}else{
											gn.linearRampToValueAtTime(n,ctx.currentTime+(15-_)*$/64)}
											if($$){gn2.setValueAtTime(z,ctx.currentTime+this.len/256)}}}
										if(!ID){fsws=fswt=$_>>3&14;fswh=($_&7)*($_&8?-1:1)}
										wlen=$$?this.len:0;};
								gn2.value=gn.value=0
								this.frq=_=>bfs.playbackRate.value=pitch=_/2048;
								this.buf=_=>bfd==_?0:(bf.copyToChannel(bfd=_,0,0),updbuf=1);
								this.envstop=_=>opt.useRamp?gn.cancelScheduledValues(ctx.currentTime):0;
								this.env=this.envs=15;this.vol=_=>(gn.value=_,_?0:this.ok=0);
								this.on=_=>!this.con?(this.con=1,bfs.connect(gnd)):0;
								this.off=_=>this.con?(this.con=0,bfs.disconnect()):0;
								this.len=this.con=0;var bfs,bfd=nwv[0];recreateBfs();
								this.upd=_=>(
									this.ok?
										mt-esws<16384?0:(
											esws+=16384,
											this.envs?(
												_=this.env+(mt-eswt)/65536/this.envs,
												gn.value=this.envs<0?(_<0?0:_)/15:(_<15?_:15)/15,
												wlen?
													(mt-eswt)/16384<wlen?
														0:
														(this.ok=0,gn2.value=0):
													0
												):0,
											fswt?(
												--fsws<0?(fsws+=fswt,
												_=HRAM[0x114]<<8&1792|HRAM[0x113],
												fswh<0?_-=_>>-fswh:_+=_>>fswh,
												_=_<0?0:_<2048?_:0,
												HRAM[0x114]=_>>8,HRAM[0x113]=_&255,
												this.frq(131072/(2048-_)),
												fswh<0?_-=_>>-fswh:_+=_>>fswh,
												_=_<0?0:_<2048?_:0,
												_?0:(this.ok=0,gn2.value=0)
												):0):0
											):
										0
									);
								},
							A=new Gnc(0,16),B=new Gnc(1,16),C=new Gnc(2,32),D=new Gnc(3,1<<15);
							this.update=_=>(this.A.upd(),this.B.upd(),this.D.upd())
							this.off=_=>(this.A.off(),this.B.off(),this.C.off(),this.D.off())
							this.on=_=>(this.A.on(),this.B.on(),this.C.on(),this.D.on())
							this.sqv=sqv;this.nwv=nwv;this.wvt=wvt;
							this.A=A;this.B=B;this.C=C;this.D=D;this.ctx=ctx;
							this.vol=(a,b)=>(mgL.gain.value=a/7,mgR.gain.value=b/7)},
				
				//	Predefined methods
					clk =_=>(mc+=_,mt+=4*_/csm),
					ick =_=>(_&1?step(0x100):_&2?step(0x101):_&4?step(0x102):_&8?step(0x103):_&16?step(0x104):0),
					iosnd=(_,$)=>(__=(_%5),_$=parseInt(_/5),_$<4?(
						$_=snd[("ABCD")[_$]],
							/*setSweep*/	__==0?_$?_$==2?$&128?0:$_.vol(0):0:0:
							/*setLength*/	__==1?($_.len=_$==2?256-$:(_$<2?
												$_.buf(snd.sqv[$>>6]):0,64-($&63))):
							/*setEnvelope*/	__==2?(_$!=2?(
												$_.env=$>>4&15,$_.envs=($&7)*($&8?1:-1),
												$&15?0:$_.envstop(),$&240?0:$_.vol(0)):(
												$_.vol(($_.env=(_=$>>5&3)?30/(1<<_):0)/15),$_.envs=0)):
							/*setFrequency*/__==3?(_=HRAM[_$*5+0x110+4],_$!=3?
												$_.frq(131072/(2048-$-(_&7)*256)):(
												$_.frq(32768/($&7?$&7:0.5)/(2<<($>>4))),
												$_.buf(snd.nwv[$>>3&1]))):
							/*setFrequency*/__==4?(_=HRAM[_$*5+0x110+3],_$!=3?(_$==2?$_.buf(snd.wvt):0,
								/*and play*/	$_.play(131072/(2048-_-($&7)*256),$&128,$&64)):
												$_.play(32768/(_&7?_&7:0.5)/(2<<(_>>4)),$&128,$&64)):0):
											__==0?snd.vol($>>0&7,$>>4&7):
											__==1?(snd.A.lrso($>>0&1,$>>4&1),snd.B.lrso($>>1&1,$>>5&1),
												snd.C.lrso($>>2&1,$>>6&1),snd.D.lrso($>>3&1,$>>7&1)):
											__==2?$&128?snd.on():(snd.off(),(()=>{for(let i=0x110;i<0x124;i++)HRAM[i]=0})()):0),
					io	= [
						/*0xFF0N*/(_,$=-1)=>(~_&8?~_&4?~_&2?~_&1?
											$<0?HRAM[0x100]&16?keys&15|16:keys>>4&15|32:HRAM[_|0x100]=$:
											$<0?HRAM[0x101]:HRAM[0x101]=$:~_&1?
											$<0?HRAM[0x102]:HRAM[0x102]=$:
											$<0?HRAM[0x103]:HRAM[0x103]=$:~_&2?~_&1?
											$<0?HRAM[0x104]:HRAM[0x104]=0:
											$<0?HRAM[0x105]:HRAM[0x105]=0:~_&1?
											$<0?HRAM[0x106]:HRAM[0x106]=$:
											$<0?HRAM[0x107]:HRAM[0x107]=$:~_&4?~_&2?~_&1?
											$<0?HRAM[0x108]:HRAM[0x108]=$:
											$<0?HRAM[0x109]:HRAM[0x109]=$:~_&1?
											$<0?HRAM[0x10A]:HRAM[0x10A]=$:
											$<0?HRAM[0x10B]:HRAM[0x10B]=$:~_&2?~_&1?
											$<0?HRAM[0x10C]:HRAM[0x10C]=$:
											$<0?HRAM[0x10D]:HRAM[0x10D]=$:~_&1?
											$<0?HRAM[0x10E]:HRAM[0x10E]=$:
											$<0?HRAM[_|0x10F]:(HRAM[0x10F]=$,ime?ick($&HRAM[0x1FF]):0)),
						/*0xFF1N*/(_,$=-1)=>($<0?HRAM[_|0x110]:(HRAM[_|0x110]=$,iosnd(_,$))),
						/*0xFF2N*/(_,$=-1)=>($<0?HRAM[_|0x120]:(HRAM[_|0x120]=$,iosnd(_+16,$))),
						/*0xFF3N*/(_,$=-1)=>(0,$<0?HRAM[_|0x130]:(HRAM[_|0x130]=$,snd.wvt[_<<1]=($>>4)/64-0.125,snd.wvt[_<<1|1]=($&15)/64-0.125)),
						/*0xFF4N*/(_,$=-1)=>
							(_==6?(()=>{if($>=0)for(let i=$<<8,j=0;j<160;)HRAM[j++]=rb[$>>4](0xFFF&i++)})():
							(_==4?$<0?HRAM[0x144]:HRAM[_|0x144]=0:
							($<0?HRAM[_|0x140]:HRAM[_|0x140]=$))),
						/*0xFF5N*/(_,$=-1)=>(_?0:$<1?0:bs=1,HRAM[_|0x150]=$),
						/*0xFF6N*/(_,$=-1)=>(0,$<0?HRAM[_|0x160]:HRAM[_|0x160]=$),
						/*0xFF7N*/(_,$=-1)=>(0,$<0?HRAM[_|0x170]:HRAM[_|0x170]=$)],
					rb	= [                        
						/*0x0NNN*/(_)=>(_&0xFF00||bs?CROM[_]:BIOS[_]),
						/*0x1NNN*/(_)=>(CROM[_|0x1000]),
						/*0x2NNN*/(_)=>(CROM[_|0x2000]),
						/*0x3NNN*/(_)=>(CROM[_|0x3000]),
						/*0x4NNN*/(_)=>(CROM[_|0x4000+mbc.cs]),
						/*0x5NNN*/(_)=>(CROM[_|0x5000+mbc.cs]),
						/*0x6NNN*/(_)=>(CROM[_|0x6000+mbc.cs]),
						/*0x7NNN*/(_)=>(CROM[_|0x7000+mbc.cs]),
						/*0x8NNN*/(_)=>(vr?255:VRAM[_|0x0000]),
						/*0x9NNN*/(_)=>(vr?255:VRAM[_|0x1000]),
						/*0xANNN*/(_)=>(ERAM[_|0x0000+mbc.es]),
						/*0xBNNN*/(_)=>(ERAM[_|0x1000+mbc.es]),
						/*0xCNNN*/(_)=>(WRAM[_|0x0000]),
						/*0xDNNN*/(_)=>(WRAM[_|0x1000]),
						/*0xENNN*/(_)=>(WRAM[_|0x0000]),
						/*0xFNNN*/(_)=>( _<0xE00? // EchWRAM or OAM/IO/HRAM?
						( WRAM[_|0x1000] ):( _<0xF00 ? // OAM or IO/HRAM?
						( vr?255:HRAM[_&0xFF] ):( _<0xF80? // IO or HRAM
							(io[_>>4&15](_&15)):(HRAM[_&0x1FF]))))],
					wb	= [
						/*0x0NNN*/(_,$)=>(mbc.tp?mbc.en=!(10^$&15):0),
						/*0x1NNN*/(_,$)=>(mbc.tp?mbc.en=!(10^$&15):0),
						/*0x2NNN*/(_,$)=>($>255?console.log("heh"):mbc.tp?mbc.cs=((mbc.tp<25?(($&=mbc.tp<15?mbc.tp<4?31:15:127)|!$):(((mbc.cs+0x4000)>>14&0xFF00|$ )))<<14)-0x4000:0),
						/*0x3NNN*/(_,$)=>($>255?console.log("heh"):mbc.tp?mbc.cs=((mbc.tp<25?(($&=mbc.tp<15?mbc.tp<4?31:15:127)|!$):((((mbc.cs+0x4000)>>14&0xFF)|($?256:0))))<<14)-0x4000:0),
						/*0x4NNN*/(_,$)=>(mbc.tp?mbc.tp<25?mbc.md?mbc.es=($&3)<<13:mbc.cs=(((mbc.cs+0x4000)>>14&31|$<<5)<<14)-0x4000:mbc.es=($&15)<<13:0),
						/*0x5NNN*/(_,$)=>(mbc.tp?mbc.tp<25?mbc.md?mbc.es=($&3)<<13:mbc.cs=(((mbc.cs+0x4000)>>14&31|$<<5)<<14)-0x4000:mbc.es=($&15)<<13:0),
						/*0x6NNN*/(_,$)=>(mbc.tp?mbc.tp<4?mbc.md=$&1:0:0),
						/*0x7NNN*/(_,$)=>(mbc.tp?mbc.tp<4?mbc.md=$&1:0:0),
						/*0x8NNN*/(_,$)=>(vr?255:VRAM[_|0x0000]=$),
						/*0x9NNN*/(_,$)=>(vr?255:VRAM[_|0x1000]=$),
						/*0xANNN*/(_,$)=>(mbc.en?ERAM[_|0x0000+mbc.es]=$:0),
						/*0xBNNN*/(_,$)=>(mbc.en?ERAM[_|0x1000+mbc.es]=$:0),
						/*0xCNNN*/(_,$)=>(WRAM[_|0x0000]=$),
						/*0xDNNN*/(_,$)=>(WRAM[_|0x1000]=$),
						/*0xENNN*/(_,$)=>(WRAM[_|0x0000]=$),
						/*0xFNNN*/(_,$)=>( _<0xE00? // EchWRAM or OAM/IO/HRAM?
						( WRAM[_|0x1000]=$ ):( _<0xF00 ? // OAM or IO/HRAM?
						( vr?255:HRAM[_&0xFF]=$ ):( _<0xF80 ? // IO or HRAM
						( io[_>>4&15](_&15,$)):( _==0xFFF ? (
						ime?ick(HRAM[0x10F]&HRAM[0x1FF]):0):0,HRAM[_&0x1FF]=$))))],
				//	Memory Management Unit
					RB	= (_)=>(clk(1), _$=rb[_>>12&15](_&0xFFF)),
					WB	= (_,$)=>(clk(1), $_=wb[_>>12&15](_&0xFFF,$)),
					RW  = (_)=>(_$= RB(_++)+RB(_)*256), // Read-Write Word
					WW  = (_,$)=>($_= WB(_++,$&255)+WB(_,$>>8)*256),
					
					CB  = [  // CB-prefix instructions
						(/*_O='CB00-rlcB   '*/)=>(F=!(B=B*2+(_=B>>7)&255)<<7|_<<4,_O),
						(/*_O='CB01-rlcC   '*/)=>(F=!(C=C*2+(_=C>>7)&255)<<7|_<<4,_O),
						(/*_O='CB02-rlcD   '*/)=>(F=!(D=D*2+(_=D>>7)&255)<<7|_<<4,_O),
						(/*_O='CB03-rlcE   '*/)=>(F=!(E=E*2+(_=E>>7)&255)<<7|_<<4,_O),
						(/*_O='CB04-rlcH   '*/)=>(F=!(H=H*2+(_=H>>7)&255)<<7|_<<4,_O),
						(/*_O='CB05-rlcL   '*/)=>(F=!(L=L*2+(_=L>>7)&255)<<7|_<<4,_O),
						(/*_O='CB06-rlcmHL '*/)=>(F=!WB($=HL(),RB($)*2+(_=_$>>7)&255)<<7|_<<4,_O),
						(/*_O='CB07-rlcA   '*/)=>(F=!(A=A*2+(_=A>>7)&255)<<7|_<<4,_O),
						(/*_O='CB08-rrcB   '*/)=>(F=!(B=(_=B&1)<<7|B>>1)<<7|_<<4,_O),
						(/*_O='CB09-rrcC   '*/)=>(F=!(C=(_=C&1)<<7|C>>1)<<7|_<<4,_O),
						(/*_O='CB0A-rrcD   '*/)=>(F=!(D=(_=D&1)<<7|D>>1)<<7|_<<4,_O),
						(/*_O='CB0B-rrcE   '*/)=>(F=!(E=(_=E&1)<<7|E>>1)<<7|_<<4,_O),
						(/*_O='CB0C-rrcH   '*/)=>(F=!(H=(_=H&1)<<7|H>>1)<<7|_<<4,_O),
						(/*_O='CB0D-rrcL   '*/)=>(F=!(L=(_=L&1)<<7|L>>1)<<7|_<<4,_O),
						(/*_O='CB0E-rrcmHL '*/)=>(F=!WB($=HL(),(_=RB($)&1)<<7|_$>>1)<<7|_<<4,_O),
						(/*_O='CB0F-rrcA   '*/)=>(F=!(A=(_=A&1)<<7|A>>1)<<7|_<<4,_O),
						(/*_O='CB10-rlB    '*/)=>(F=B>>7<<4|!(B=B*2+!!(F&16)&255)<<7,_O),
						(/*_O='CB11-rlC    '*/)=>(F=C>>7<<4|!(C=C*2+!!(F&16)&255)<<7,_O),
						(/*_O='CB12-rlD    '*/)=>(F=D>>7<<4|!(D=D*2+!!(F&16)&255)<<7,_O),
						(/*_O='CB13-rlE    '*/)=>(F=E>>7<<4|!(E=E*2+!!(F&16)&255)<<7,_O),
						(/*_O='CB14-rlH    '*/)=>(F=H>>7<<4|!(H=H*2+!!(F&16)&255)<<7,_O),
						(/*_O='CB15-rlL    '*/)=>(F=L>>7<<4|!(L=L*2+!!(F&16)&255)<<7,_O),
						(/*_O='CB16-rlmHL  '*/)=>(F=RB($=HL())>>7<<4|!WB($,_$*2+!!(F&16)&255)<<7,_O),
						(/*_O='CB17-rlA    '*/)=>(F=A>>7<<4|!(A=A*2+!!(F&16)&255)<<7,_O),
						(/*_O='CB18-rrB    '*/)=>(F=(B&1)<<4|!(B=(F&16)<<3|B>>1)<<7,_O),
						(/*_O='CB19-rrC    '*/)=>(F=(C&1)<<4|!(C=(F&16)<<3|C>>1)<<7,_O),
						(/*_O='CB1A-rrD    '*/)=>(F=(D&1)<<4|!(D=(F&16)<<3|D>>1)<<7,_O),
						(/*_O='CB1B-rrE    '*/)=>(F=(E&1)<<4|!(E=(F&16)<<3|E>>1)<<7,_O),
						(/*_O='CB1C-rrH    '*/)=>(F=(H&1)<<4|!(H=(F&16)<<3|H>>1)<<7,_O),
						(/*_O='CB1D-rrL    '*/)=>(F=(L&1)<<4|!(L=(F&16)<<3|L>>1)<<7,_O),
						(/*_O='CB1E-rrmHL  '*/)=>(F=(RB($=HL())&1)<<4|!WB($,(F&16)<<3|_$>>1)<<7,_O),
						(/*_O='CB1F-rrA    '*/)=>(F=(A&1)<<4|!(A=(F&16)<<3|A>>1)<<7,_O),
						(/*_O='CB20-slaB   '*/)=>(F=B>>7<<4|!(B=B<<1&255)<<7,_O),
						(/*_O='CB21-slaC   '*/)=>(F=C>>7<<4|!(C=C<<1&255)<<7,_O),
						(/*_O='CB22-slaD   '*/)=>(F=D>>7<<4|!(D=D<<1&255)<<7,_O),
						(/*_O='CB23-slaE   '*/)=>(F=E>>7<<4|!(E=E<<1&255)<<7,_O),
						(/*_O='CB24-slaH   '*/)=>(F=H>>7<<4|!(H=H<<1&255)<<7,_O),
						(/*_O='CB25-slaL   '*/)=>(F=L>>7<<4|!(L=L<<1&255)<<7,_O),
						(/*_O='CB26-slamHL '*/)=>(F=RB($=HL())>>7<<4|!WB($,_$<<1&255)<<7,_O),
						(/*_O='CB27-slaA   '*/)=>(F=A>>7<<4|!(A=A<<1&255)<<7,_O),
						(/*_O='CB28-sraB   '*/)=>(F=(B&1)<<4|!(B=B>>1|B&128)<<7,_O),
						(/*_O='CB29-sraC   '*/)=>(F=(C&1)<<4|!(C=C>>1|C&128)<<7,_O),
						(/*_O='CB2A-sraD   '*/)=>(F=(D&1)<<4|!(D=D>>1|D&128)<<7,_O),
						(/*_O='CB2B-sraE   '*/)=>(F=(E&1)<<4|!(E=E>>1|E&128)<<7,_O),
						(/*_O='CB2C-sraH   '*/)=>(F=(H&1)<<4|!(H=H>>1|H&128)<<7,_O),
						(/*_O='CB2D-sraL   '*/)=>(F=(L&1)<<4|!(L=L>>1|L&128)<<7,_O),
						(/*_O='CB2E-sramHL '*/)=>(F=(RB($=HL())&1)<<4|!WB($,_$>>1|_$&128)<<7,_O),
						(/*_O='CB2F-sraA   '*/)=>(F=(A&1)<<4|!(A=A>>1|A&128)<<7,_O),
						(/*_O='CB30-swpB   '*/)=>(F=!(B=(B>>4|B<<4)&255)<<7,_O),
						(/*_O='CB31-swpC   '*/)=>(F=!(C=(C>>4|C<<4)&255)<<7,_O),
						(/*_O='CB32-swpD   '*/)=>(F=!(D=(D>>4|D<<4)&255)<<7,_O),
						(/*_O='CB33-swpE   '*/)=>(F=!(E=(E>>4|E<<4)&255)<<7,_O),
						(/*_O='CB34-swpH   '*/)=>(F=!(H=(H>>4|H<<4)&255)<<7,_O),
						(/*_O='CB35-swpL   '*/)=>(F=!(L=(L>>4|L<<4)&255)<<7,_O),
						(/*_O='CB36-swpmHL '*/)=>(F=!WB($=HL(),(RB($)>>4|_$<<4)&255)<<7,_O),
						(/*_O='CB37-swpA   '*/)=>(F=!(A=(A>>4|A<<4)&255)<<7,_O),
						(/*_O='CB38-srlB   '*/)=>(F=(B&1)<<4|!(B=B>>1)<<7,_O),
						(/*_O='CB39-srlC   '*/)=>(F=(C&1)<<4|!(C=C>>1)<<7,_O),
						(/*_O='CB3A-srlD   '*/)=>(F=(D&1)<<4|!(D=D>>1)<<7,_O),
						(/*_O='CB3B-srlE   '*/)=>(F=(E&1)<<4|!(E=E>>1)<<7,_O),
						(/*_O='CB3C-srlH   '*/)=>(F=(H&1)<<4|!(H=H>>1)<<7,_O),
						(/*_O='CB3D-srlL   '*/)=>(F=(L&1)<<4|!(L=L>>1)<<7,_O),
						(/*_O='CB3E-srlmHL '*/)=>(F=(RB($=HL())&1)<<4|!WB($,_$>>1)<<7,_O),
						(/*_O='CB3F-srlA   '*/)=>(F=(A&1)<<4|!(A=A>>1)<<7,_O),
						(/*_O='CB40-bit0B  '*/)=>(F=!(B&1)<<7|32|F&31,_O),
						(/*_O='CB41-bit0C  '*/)=>(F=!(C&1)<<7|32|F&31,_O),
						(/*_O='CB42-bit0D  '*/)=>(F=!(D&1)<<7|32|F&31,_O),
						(/*_O='CB43-bit0E  '*/)=>(F=!(E&1)<<7|32|F&31,_O),
						(/*_O='CB44-bit0H  '*/)=>(F=!(H&1)<<7|32|F&31,_O),
						(/*_O='CB45-bit0L  '*/)=>(F=!(L&1)<<7|32|F&31,_O),
						(/*_O='CB46-bit0mHL'*/)=>(F=!(RB(HL())&1)<<7|32|F&31,_O),
						(/*_O='CB47-bit0A  '*/)=>(F=!(A&1)<<7|32|F&31,_O),
						(/*_O='CB48-bit1B  '*/)=>(F=!(B&2)<<7|32|F&31,_O),
						(/*_O='CB49-bit1C  '*/)=>(F=!(C&2)<<7|32|F&31,_O),
						(/*_O='CB4A-bit1D  '*/)=>(F=!(D&2)<<7|32|F&31,_O),
						(/*_O='CB4B-bit1E  '*/)=>(F=!(E&2)<<7|32|F&31,_O),
						(/*_O='CB4C-bit1H  '*/)=>(F=!(H&2)<<7|32|F&31,_O),
						(/*_O='CB4D-bit1L  '*/)=>(F=!(L&2)<<7|32|F&31,_O),
						(/*_O='CB4E-bit1mHL'*/)=>(F=!(RB(HL())&2)<<7|32|F&31,_O),
						(/*_O='CB4F-bit1A  '*/)=>(F=!(A&2)<<7|32|F&31,_O),
						(/*_O='CB50-bit2B  '*/)=>(F=!(B&4)<<7|32|F&31,_O),	
						(/*_O='CB51-bit2C  '*/)=>(F=!(C&4)<<7|32|F&31,_O),
						(/*_O='CB52-bit2D  '*/)=>(F=!(D&4)<<7|32|F&31,_O),	
						(/*_O='CB53-bit2E  '*/)=>(F=!(E&4)<<7|32|F&31,_O),
						(/*_O='CB54-bit2H  '*/)=>(F=!(H&4)<<7|32|F&31,_O),	
						(/*_O='CB55-bit2L  '*/)=>(F=!(L&4)<<7|32|F&31,_O),
						(/*_O='CB56-bit2mHL'*/)=>(F=!(RB(HL())&4)<<7|32|F&31,_O),
						(/*_O='CB57-bit2A  '*/)=>(F=!(A&4)<<7|32|F&31,_O),
						(/*_O='CB58-bit3B  '*/)=>(F=!(B&8)<<7|32|F&31,_O),		
						(/*_O='CB59-bit3C  '*/)=>(F=!(C&8)<<7|32|F&31,_O),
						(/*_O='CB5A-bit3D  '*/)=>(F=!(D&8)<<7|32|F&31,_O),		
						(/*_O='CB5B-bit3E  '*/)=>(F=!(E&8)<<7|32|F&31,_O),
						(/*_O='CB5C-bit3H  '*/)=>(F=!(H&8)<<7|32|F&31,_O),	
						(/*_O='CB5D-bit3L  '*/)=>(F=!(L&8)<<7|32|F&31,_O),
						(/*_O='CB5E-bit3mHL'*/)=>(F=!(RB(HL())&8)<<7|32|F&31,_O),
						(/*_O='CB5F-bit3A  '*/)=>(F=!(A&8)<<7|32|F&31,_O),
						(/*_O='CB60-bit4B  '*/)=>(F=!(B&16)<<7|32|F&31,_O),		
						(/*_O='CB61-bit4C  '*/)=>(F=!(C&16)<<7|32|F&31,_O),
						(/*_O='CB62-bit4D  '*/)=>(F=!(D&16)<<7|32|F&31,_O),		
						(/*_O='CB63-bit4E  '*/)=>(F=!(E&16)<<7|32|F&31,_O),
						(/*_O='CB64-bit4H  '*/)=>(F=!(H&16)<<7|32|F&31,_O),		
						(/*_O='CB65-bit4L  '*/)=>(F=!(L&16)<<7|32|F&31,_O),
						(/*_O='CB66-bit4mHL'*/)=>(F=!(RB(HL())&16)<<7|32|F&31,_O),
						(/*_O='CB67-bit4A  '*/)=>(F=!(A&16)<<7|32|F&31,_O),
						(/*_O='CB68-bit5B  '*/)=>(F=!(B&32)<<7|32|F&31,_O),	
						(/*_O='CB69-bit5C  '*/)=>(F=!(C&32)<<7|32|F&31,_O),
						(/*_O='CB6A-bit5D  '*/)=>(F=!(D&32)<<7|32|F&31,_O),
						(/*_O='CB6B-bit5E  '*/)=>(F=!(E&32)<<7|32|F&31,_O),
						(/*_O='CB6C-bit5H  '*/)=>(F=!(H&32)<<7|32|F&31,_O),
						(/*_O='CB6D-bit5L  '*/)=>(F=!(L&32)<<7|32|F&31,_O),
						(/*_O='CB6E-bit5mHL'*/)=>(F=!(RB(HL())&32)<<7|32|F&31,_O),
						(/*_O='CB6F-bit5A  '*/)=>(F=!(A&32)<<7|32|F&31,_O),
						(/*_O='CB70-bit6B  '*/)=>(F=!(B&64)<<7|32|F&31,_O),
						(/*_O='CB71-bit6C  '*/)=>(F=!(C&64)<<7|32|F&31,_O),
						(/*_O='CB72-bit6D  '*/)=>(F=!(D&64)<<7|32|F&31,_O),
						(/*_O='CB73-bit6E  '*/)=>(F=!(E&64)<<7|32|F&31,_O),
						(/*_O='CB74-bit6H  '*/)=>(F=!(H&64)<<7|32|F&31,_O),
						(/*_O='CB75-bit6L  '*/)=>(F=!(L&64)<<7|32|F&31,_O),
						(/*_O='CB76-bit6mHL'*/)=>(F=!(RB(HL())&64)<<7|32|F&31,_O),
						(/*_O='CB77-bit6A  '*/)=>(F=!(A&64)<<7|32|F&31,_O),
						(/*_O='CB78-bit7B  '*/)=>(F=!(B&128)<<7|32|F&31,_O),		
						(/*_O='CB79-bit7C  '*/)=>(F=!(C&128)<<7|32|F&31,_O),
						(/*_O='CB7A-bit7D  '*/)=>(F=!(D&128)<<7|32|F&31,_O),		
						(/*_O='CB7B-bit7E  '*/)=>(F=!(E&128)<<7|32|F&31,_O),
						(/*_O='CB7C-bit7H  '*/)=>(F=!(H&128)<<7|32|F&31,_O),		
						(/*_O='CB7D-bit7L  '*/)=>(F=!(L&128)<<7|32|F&31,_O),
						(/*_O='CB7E-bit7mHL'*/)=>(F=!(RB(HL())&128)<<7|32|F&31,_O),
						(/*_O='CB7F-bit7A  '*/)=>(F=!(A&128)<<7|32|F&31,_O),
						(/*_O='CB80-res0B  '*/)=>(B=B&254,_O),
						(/*_O='CB81-res0C  '*/)=>(C=C&254,_O),
						(/*_O='CB82-res0D  '*/)=>(D=D&254,_O),
						(/*_O='CB83-res0E  '*/)=>(E=E&254,_O),
						(/*_O='CB84-res0H  '*/)=>(H=H&254,_O),
						(/*_O='CB85-res0L  '*/)=>(L=L&254,_O),
						(/*_O='CB86-res0mHL'*/)=>(WB($=HL(),RB($)&254),_O),
						(/*_O='CB87-res0A  '*/)=>(A=A&254,_O),
						(/*_O='CB88-res1B  '*/)=>(B=B&253,_O),	
						(/*_O='CB89-res1C  '*/)=>(C=C&253,_O),	
						(/*_O='CB8A-res1D  '*/)=>(D=D&253,_O),
						(/*_O='CB8B-res1E  '*/)=>(E=E&253,_O),	
						(/*_O='CB8C-res1mHL'*/)=>(H=H&253,_O),	
						(/*_O='CB8D-res1L  '*/)=>(L=L&253,_O),
						(/*_O='CB8E-res1m  '*/)=>(WB($=HL(),RB($)&253),_O),
						(/*_O='CB8F-res1A  '*/)=>(A=A&253,_O),
						(/*_O='CB90-res2B  '*/)=>(B=B&251,_O),
						(/*_O='CB91-res2C  '*/)=>(C=C&251,_O),
						(/*_O='CB92-res2D  '*/)=>(D=D&251,_O),
						(/*_O='CB93-res2E  '*/)=>(E=E&251,_O),
						(/*_O='CB94-res2H  '*/)=>(H=H&251,_O),
						(/*_O='CB95-res2L  '*/)=>(L=L&251,_O),
						(/*_O='CB96-res2mHL'*/)=>(WB($=HL(),RB($)&251),_O),
						(/*_O='CB97-res2A  '*/)=>(A=A&251,_O),
						(/*_O='CB98-res3B  '*/)=>(B=B&247,_O),
						(/*_O='CB99-res3C  '*/)=>(C=C&247,_O),
						(/*_O='CB9A-res3D  '*/)=>(D=D&247,_O),
						(/*_O='CB9B-res3E  '*/)=>(E=E&247,_O),
						(/*_O='CB9C-res3mHL'*/)=>(H=H&247,_O),
						(/*_O='CB9D-res3L  '*/)=>(L=L&247,_O),
						(/*_O='CB9E-res3m  '*/)=>(WB($=HL(),RB($)&247),_O),
						(/*_O='CB9F-res3A  '*/)=>(A=A&247,_O),
						(/*_O='CBA0-res4B  '*/)=>(B=B&239,_O),
						(/*_O='CBA1-res4C  '*/)=>(C=C&239,_O),
						(/*_O='CBA2-res4D  '*/)=>(D=D&239,_O),
						(/*_O='CBA3-res4E  '*/)=>(E=E&239,_O),
						(/*_O='CBA4-res4H  '*/)=>(H=H&239,_O),
						(/*_O='CBA5-res4L  '*/)=>(L=L&239,_O),
						(/*_O='CBA6-res4mHL'*/)=>(WB($=HL(),RB($)&239),_O),
						(/*_O='CBA7-res4A  '*/)=>(A=A&239,_O),
						(/*_O='CBA8-res5B  '*/)=>(B=B&223,_O),
						(/*_O='CBA9-res5C  '*/)=>(C=C&223,_O),
						(/*_O='CBAA-res5D  '*/)=>(D=D&223,_O),
						(/*_O='CBAB-res5E  '*/)=>(E=E&223,_O),
						(/*_O='CBAC-res5mHL'*/)=>(H=H&223,_O),
						(/*_O='CBAD-res5L  '*/)=>(L=L&223,_O),
						(/*_O='CBAE-res5m  '*/)=>(WB($=HL(),RB($)&223),_O),
						(/*_O='CBAF-res5A  '*/)=>(A=A&223,_O),
						(/*_O='CBB0-res6B  '*/)=>(B=B&191,_O),
						(/*_O='CBB1-res6C  '*/)=>(C=C&191,_O),
						(/*_O='CBB2-res6D  '*/)=>(D=D&191,_O),
						(/*_O='CBB3-res6E  '*/)=>(E=E&191,_O),
						(/*_O='CBB4-res6H  '*/)=>(H=H&191,_O),
						(/*_O='CBB5-res6L  '*/)=>(L=L&191,_O),
						(/*_O='CBB6-res6mHL'*/)=>(WB($=HL(),RB($)&191),_O),
						(/*_O='CBB7-res6A  '*/)=>(A=A&191,_O),
						(/*_O='CBB8-res7B  '*/)=>(B=B&127,_O),
						(/*_O='CBB9-res7C  '*/)=>(C=C&127,_O),
						(/*_O='CBBA-res7D  '*/)=>(D=D&127,_O),
						(/*_O='CBBB-res7E  '*/)=>(E=E&127,_O),
						(/*_O='CBBC-res7mHL'*/)=>(H=H&127,_O),
						(/*_O='CBBD-res7L  '*/)=>(L=L&127,_O),
						(/*_O='CBBE-res7m  '*/)=>(WB($=HL(),RB($)&127),_O),
						(/*_O='CBBF-res7A  '*/)=>(A=A&127,_O),
						(/*_O='CBC0-set0B  '*/)=>(B=B|1,_O),
						(/*_O='CBC1-set0C  '*/)=>(C=C|1,_O),
						(/*_O='CBC2-set0D  '*/)=>(D=D|1,_O),
						(/*_O='CBC3-set0E  '*/)=>(E=E|1,_O),
						(/*_O='CBC4-set0H  '*/)=>(H=H|1,_O),
						(/*_O='CBC5-set0L  '*/)=>(L=L|1,_O),
						(/*_O='CBC6-set0mHL'*/)=>(WB($=HL(),RB($)|1),_O),
						(/*_O='CBC7-set0A  '*/)=>(A=A|1,_O),
						(/*_O='CBC8-set1B  '*/)=>(B=B|2,_O),
						(/*_O='CBC9-set1C  '*/)=>(C=C|2,_O),
						(/*_O='CBCA-set1D  '*/)=>(D=D|2,_O),
						(/*_O='CBCB-set1E  '*/)=>(E=E|2,_O),
						(/*_O='CBCC-set1mHL'*/)=>(H=H|2,_O),
						(/*_O='CBCD-set1L  '*/)=>(L=L|2,_O),
						(/*_O='CBCE-set1m  '*/)=>(WB($=HL(),RB($)|2),_O),
						(/*_O='CBCF-set1A  '*/)=>(A=A|2,_O),
						(/*_O='CBD0-set2B  '*/)=>(B=B|4,_O),
						(/*_O='CBD1-set2C  '*/)=>(C=C|4,_O),
						(/*_O='CBD2-set2D  '*/)=>(D=D|4,_O),
						(/*_O='CBD3-set2E  '*/)=>(E=E|4,_O),
						(/*_O='CBD4-set2H  '*/)=>(H=H|4,_O),
						(/*_O='CBD5-set2L  '*/)=>(L=L|4,_O),
						(/*_O='CBD6-set2mHL'*/)=>(WB($=HL(),RB($)|4),_O),
						(/*_O='CBD7-set2A  '*/)=>(A=A|4,_O),
						(/*_O='CBD8-set3B  '*/)=>(B=B|8,_O),
						(/*_O='CBD9-set3C  '*/)=>(C=C|8,_O),
						(/*_O='CBDA-set3D  '*/)=>(D=D|8,_O),
						(/*_O='CBDB-set3E  '*/)=>(E=E|8,_O),
						(/*_O='CBDC-set3mHL'*/)=>(H=H|8,_O),
						(/*_O='CBDD-set3L  '*/)=>(L=L|8,_O),
						(/*_O='CBDE-set3m  '*/)=>(WB($=HL(),RB($)|8),_O),
						(/*_O='CBDF-set3A  '*/)=>(A=A|8,_O),
						(/*_O='CBE0-set4B  '*/)=>(B=B|16,_O),
						(/*_O='CBE1-set4C  '*/)=>(C=C|16,_O),
						(/*_O='CBE2-set4D  '*/)=>(D=D|16,_O),
						(/*_O='CBE3-set4E  '*/)=>(E=E|16,_O),
						(/*_O='CBE4-set4H  '*/)=>(H=H|16,_O),
						(/*_O='CBE5-set4L  '*/)=>(L=L|16,_O),
						(/*_O='CBE6-set4mHL'*/)=>(WB($=HL(),RB($)|16),_O),
						(/*_O='CBE7-set4A  '*/)=>(A=A|16,_O),
						(/*_O='CBE8-set5B  '*/)=>(B=B|32,_O),
						(/*_O='CBE9-set5C  '*/)=>(C=C|32,_O),
						(/*_O='CBEA-set5D  '*/)=>(D=D|32,_O),
						(/*_O='CBEB-set5E  '*/)=>(E=E|32,_O),
						(/*_O='CBEC-set5mHL'*/)=>(H=H|32,_O),
						(/*_O='CBED-set5L  '*/)=>(L=L|32,_O),
						(/*_O='CBEE-set5m  '*/)=>(WB($=HL(),RB($)|32),_O),
						(/*_O='CBEF-set5A  '*/)=>(A=A|32,_O),
						(/*_O='CBF0-set6B  '*/)=>(B=B|64,_O),
						(/*_O='CBF1-set6C  '*/)=>(C=C|64,_O),
						(/*_O='CBF2-set6D  '*/)=>(D=D|64,_O),
						(/*_O='CBF3-set6E  '*/)=>(E=E|64,_O),
						(/*_O='CBF4-set6H  '*/)=>(H=H|64,_O),
						(/*_O='CBF5-set6L  '*/)=>(L=L|64,_O),
						(/*_O='CBF6-set6mHL'*/)=>(WB($=HL(),RB($)|64),_O),
						(/*_O='CBF7-set6A  '*/)=>(A=A|64,_O),
						(/*_O='CBF8-set7B  '*/)=>(B=B|128,_O),
						(/*_O='CBF9-set7C  '*/)=>(C=C|128,_O),
						(/*_O='CBFA-set7D  '*/)=>(D=D|128,_O),
						(/*_O='CBFB-set7E  '*/)=>(E=E|128,_O),
						(/*_O='CBFC-set7mHL'*/)=>(H=H|128,_O),
						(/*_O='CBFD-set7L  '*/)=>(L=L|128,_O),
						(/*_O='CBFE-set7m  '*/)=>(WB($=HL(),RB($)|128),_O),
						(/*_O='CBFF-set7A  '*/)=>(A=A|128,_O)],
					
					z80 = [ 
						(/*_O='00-noop     '*/)=>(_O),
						(/*_O='01-ldBCnn   '*/)=>(BC(RW(PC++)),PC++,_O),
						(/*_O='02-ldmBCA   '*/)=>(WB(BC(),A),_O),
						(/*_O='03-incBC    '*/)=>(BC(BC()+1&65535),_O),
						(/*_O='04-incB     '*/)=>(F=!(B=++B&255)<<7|!(B&15)<<5|F&16,_O),
						(/*_O='05-decB     '*/)=>(F=!(B=--B&255)<<7|!(B&15^15)<<5|F&16|64,_O),
						(/*_O='06-ldBn     '*/)=>(B=RB(PC++),_O),
						(/*_O='07-rlcA     '*/)=>(F=(A=A>>7|A<<1&255)<<4&16,_O),
						(/*_O='08-ldmnnSP  '*/)=>(WW(RW(PC++),SP),PC++,_O),
						(/*_O='09-addHLBC  '*/)=>(_=HL(),$=_+BC(),HL($&65535),F=$>>12&16|(_^$^$-_)>>7&32|F&128,_O),
						(/*_O='0A-ldAmBC   '*/)=>(A=RB(BC()),_O),
						(/*_O='0B-decBC    '*/)=>(BC(BC()-1&65535),_O),
						(/*_O='0C-incC     '*/)=>(F=!(C=++C&255)<<7|!(C&15)<<5|F&16,_O),
						(/*_O='0D-decC     '*/)=>(F=!(C=--C&255)<<7|!(C&15^15)<<5|F&16|64,_O),
						(/*_O='0E-ldCn     '*/)=>(C=RB(PC++),_O),
						(/*_O='0F-rrcA     '*/)=>(F=(A=A>>1|A<<7&255)>>3&16,_O),
						(/*_O='10-stop     '*/)=>(stop=1,_O),
						(/*_O='11-ldDEnn   '*/)=>(DE(RW(PC++)),PC++,_O),
						(/*_O='12-ldmDEA   '*/)=>(WB(DE(),A),_O),
						(/*_O='13-incDE    '*/)=>(DE(DE()+1&65535),_O),
						(/*_O='14-incD     '*/)=>(F=!(D=++D&255)<<7|!(D&15)<<5|F&16,_O),
						(/*_O='15-decD     '*/)=>(F=!(D=--D&255)<<7|!(D&15^15)<<5|F&16|64,_O),
						(/*_O='16-ldDn     '*/)=>(D=RB(PC++),_O),
						(/*_O='17-rlA      '*/)=>(F=(A=F>>4&1|A<<1)>>4&16,A&=255,_O),
						(/*_O='18-jrn      '*/)=>(PC+=RB(PC)-(_$<<1&256)+1,clk(1),_O),
						(/*_O='19-addHLDE  '*/)=>(_=HL(),$=_+DE(),HL($&65535),F=$>>12&16|(_^$^$-_)>>7&32|F&128,_O),
						(/*_O='1A-ldAmDE   '*/)=>(A=RB(DE()),_O),
						(/*_O='1B-decDE    '*/)=>(DE(DE()-1&65535),_O),
						(/*_O='1C-incE     '*/)=>(F=!(E=++E&255)<<7|!(E&15)<<5|F&16,_O),
						(/*_O='1D-decE     '*/)=>(F=!(E=--E&255)<<7|!(E&15^15)<<5|F&16|64,_O),
						(/*_O='1E-ldEn     '*/)=>(E=RB(PC++),_O),
						(/*_O='1F-rrA      '*/)=>(F=(A|=F<<4)<<4&16,A=A>>1&255,_O),
						(/*_O='20-jrNZn    '*/)=>(PC+=F&128?1:RB(PC)-(_$<<1&256)+1,clk(1),_O),
						(/*_O='21-ldHLnn   '*/)=>(HL(RW(PC++)),PC++,_O),
						(/*_O='22-ldimHLA  '*/)=>(WB($=HL(),A),HL(++$&65535),_O),
						(/*_O='23-incHL    '*/)=>(HL(HL()+1&65535),_O),
						(/*_O='24-incH     '*/)=>(F=!(H=++H&255)<<7|!(H&15)<<5|F&16,_O),
						(/*_O='25-decH     '*/)=>(F=!(H=--H&255)<<7|!(H&15^15)<<5|F&16|64,_O),
						(/*_O='26-ldHn     '*/)=>(H=RB(PC++),_O),
						(/*_O='27-DAA      '*/)=>(A+=(((F>>5&1)||(A&15)>9)*6+((F>>4&1)||(A&240)>153)*96)*(F&64?-1:1),F=A>>4&16|F&64|!(A&=255)<<7,_O), 
						(/*_O='28-jrZn     '*/)=>(PC+=F&128?RB(PC)-(_$<<1&256)+1:1,clk(1),_O),
						(/*_O='29-addHLHL  '*/)=>($=HL()<<1,HL($&65535),F=$>>12&16|$>>7&32|F&128,_O),
						(/*_O='2A-ldiAmHL  '*/)=>(A=RB($=HL()),HL(++$&65535),_O),
						(/*_O='2B-decHL    '*/)=>(HL(HL()-1&65535),_O),
						(/*_O='2C-incL     '*/)=>(F=!(L=++L&255)<<7|!(L&15)<<5|F&16,_O),
						(/*_O='2D-decL     '*/)=>(F=!(L=--L&255)<<7|!(L&15^15)<<5|F&16|64,_O),
						(/*_O='2E-ldLn     '*/)=>(L=RB(PC++),_O),
						(/*_O='2F-cpl      '*/)=>(A^=255,F|=96,_O),
						(/*_O='30-jrNCn    '*/)=>(PC+=F&16?1:RB(PC)-2*(_$&128)+1,clk(1),_O),
						(/*_O='31-ldSPnn   '*/)=>(SP=RW(PC++),PC++,_O),
						(/*_O='32-lddmHLA  '*/)=>(WB($=HL(),A),HL(--$&65535),_O),
						(/*_O='33-incSP    '*/)=>(SP=++SP&65535,_O),
						(/*_O='34-incmHL   '*/)=>(F=!(WB($=HL(),RB($)+1&255))<<7|!($_&15)<<5|F&16,_O),
						(/*_O='35-decmHL   '*/)=>(F=!(WB($=HL(),RB($)-1&255))<<7|!($_&15^15)<<5|F&16|64,_O),
						(/*_O='36-ldmHLn   '*/)=>(WB(HL(),RB(PC++)),_O),
						(/*_O='37-scF      '*/)=>(F=16|F&128,_O),
						(/*_O='38-jrCn     '*/)=>(PC+=F&16?RB(PC)-2*(_$&128)+1:1,clk(1),_O),
						(/*_O='39-addHLSP  '*/)=>(_=HL(),$=_+SP,HL($&65535),F=$>>12&16|(_^$^SP)>>7&32|F&128,_O),
						(/*_O='3A-lddAmHL  '*/)=>(A=RB($=HL()),HL(--$&65535),_O),
						(/*_O='3B-decSP    '*/)=>(SP=--SP&65535,_O),
						(/*_O='3C-incA     '*/)=>(F=!(A=++A&255)<<7|!(A&15)<<5|F&16,_O),
						(/*_O='3D-decA     '*/)=>(F=!(A=--A&255)<<7|!(A&15^15)<<5|F&16|64,_O),
						(/*_O='3E-ldAn     '*/)=>(A=RB(PC++),_O),
						(/*_O='3F-ccF      '*/)=>(F=16^F&144,_O),
						(/*_O='40-ldBB     '*/)=>(_O),
						(/*_O='41-ldBC     '*/)=>(B=C,_O),
						(/*_O='42-ldBD     '*/)=>(B=D,_O),
						(/*_O='43-ldBE     '*/)=>(B=E,_O),
						(/*_O='44-ldBH     '*/)=>(B=H,_O),
						(/*_O='45-ldBL     '*/)=>(B=L,_O),
						(/*_O='46-ldBmHL   '*/)=>(B=RB(HL()),_O),
						(/*_O='47-ldBA     '*/)=>(B=A,_O),
						(/*_O='48-ldCB     '*/)=>(C=B,_O),
						(/*_O='49-ldCC     '*/)=>(_O),     
						(/*_O='4A-ldCD     '*/)=>(C=D,_O),
						(/*_O='4B-ldCE     '*/)=>(C=E,_O),
						(/*_O='4C-ldCH     '*/)=>(C=H,_O),  
						(/*_O='4D-ldCL     '*/)=>(C=L,_O),
						(/*_O='4E-ldCmHL   '*/)=>(C=RB(HL()),_O),
						(/*_O='4F-ldCA     '*/)=>(C=A,_O),
						(/*_O='50-ldDB     '*/)=>(D=B,_O),
						(/*_O='51-ldDC     '*/)=>(D=C,_O),
						(/*_O='52-ldDD     '*/)=>(_O),
						(/*_O='53-ldDE     '*/)=>(D=E,_O),
						(/*_O='54-ldDH     '*/)=>(D=H,_O),
						(/*_O='55-ldDL     '*/)=>(D=L,_O),
						(/*_O='56-ldDmHL   '*/)=>(D=RB(HL()),_O),
						(/*_O='57-ldDA     '*/)=>(D=A,_O),
						(/*_O='58-ldEB     '*/)=>(E=B,_O),
						(/*_O='59-ldEC     '*/)=>(E=C,_O),
						(/*_O='5A-ldED     '*/)=>(E=D,_O),	
						(/*_O='5B-ldEE     '*/)=>(_O),
						(/*_O='5C-ldEH     '*/)=>(E=H,_O),
						(/*_O='5D-ldEL     '*/)=>(E=L,_O),
						(/*_O='5E-ldEmHL   '*/)=>(E=RB(HL()),_O),
						(/*_O='5F-ldEA     '*/)=>(E=A,_O),				
						(/*_O='60-ldHB     '*/)=>(H=B,_O),
						(/*_O='61-ldHC     '*/)=>(H=C,_O),
						(/*_O='62-ldHD     '*/)=>(H=D,_O),
						(/*_O='63-ldHE     '*/)=>(H=E,_O),
						(/*_O='64-ldHH     '*/)=>(_O),
						(/*_O='65-ldHL     '*/)=>(H=L,_O),
						(/*_O='66-ldHmHL   '*/)=>(H=RB(HL()),_O),
						(/*_O='67-ldHA     '*/)=>(H=A,_O),
						(/*_O='68-ldLB     '*/)=>(L=B,_O),
						(/*_O='69-ldLC     '*/)=>(L=C,_O),
						(/*_O='6A-ldLD     '*/)=>(L=D,_O),
						(/*_O='6B-ldLE     '*/)=>(L=E,_O),
						(/*_O='6C-ldLH     '*/)=>(L=H,_O),
						(/*_O='6D-ldLL     '*/)=>(_O),
						(/*_O='6E-ldLmHL   '*/)=>(L=RB(HL()),_O),
						(/*_O='6F-ldLA     '*/)=>(L=A,_O),
						(/*_O='70-ldmHLB   '*/)=>(WB(HL(),B),_O),
						(/*_O='71-ldmHLC   '*/)=>(WB(HL(),C),_O),
						(/*_O='72-ldmHLD   '*/)=>(WB(HL(),D),_O),
						(/*_O='73-ldmHLE   '*/)=>(WB(HL(),E),_O),
						(/*_O='74-ldmHLH   '*/)=>(WB(HL(),H),_O),
						(/*_O='75-ldmHLL   '*/)=>(WB(HL(),L),_O),
						(/*_O='76-halt     '*/)=>(halt=1,_O),
						(/*_O='77-ldmHLA   '*/)=>(WB(HL(),A),_O),
						(/*_O='78-ldAB     '*/)=>(A=B,_O),
						(/*_O='79-ldAC     '*/)=>(A=C,_O),
						(/*_O='7A-ldAD     '*/)=>(A=D,_O),
						(/*_O='7B-ldAE     '*/)=>(A=E,_O),
						(/*_O='7C-ldAH     '*/)=>(A=H,_O),
						(/*_O='7D-ldAL     '*/)=>(A=L,_O),
						(/*_O='7E-ldAmHL   '*/)=>(A=RB(HL()),_O),
						(/*_O='7F-ldAA     '*/)=>(_O),
						(/*_O='80-addAB    '*/)=>(F=(_=A+B)>>4&16|(A^B^_)<<1&32|!(A=_&255)<<7,_O),
						(/*_O='81-addAC    '*/)=>(F=(_=A+C)>>4&16|(A^C^_)<<1&32|!(A=_&255)<<7,_O),
						(/*_O='82-addAD    '*/)=>(F=(_=A+D)>>4&16|(A^D^_)<<1&32|!(A=_&255)<<7,_O),
						(/*_O='83-addAE    '*/)=>(F=(_=A+E)>>4&16|(A^E^_)<<1&32|!(A=_&255)<<7,_O),
						(/*_O='84-addAH    '*/)=>(F=(_=A+H)>>4&16|(A^H^_)<<1&32|!(A=_&255)<<7,_O),
						(/*_O='85-addAL    '*/)=>(F=(_=A+L)>>4&16|(A^L^_)<<1&32|!(A=_&255)<<7,_O),
						(/*_O='86-addAmHL  '*/)=>(F=(_=A+RB(HL()))>>4&16|(A^_$^_)<<1&32|!(A=_&255)<<7,_O),
						(/*_O='87-addAA    '*/)=>(F=(_=A+A)>>4&16|(A^A^_)<<1&32|!(A=_&255)<<7,_O),
						(/*_O='88-adcAB    '*/)=>(F=(_=A+(F>>4&1)+B)>>4&16|(A^B^_)<<1&32|!(A=_&255)<<7,_O),
						(/*_O='89-adcAC    '*/)=>(F=(_=A+(F>>4&1)+C)>>4&16|(A^C^_)<<1&32|!(A=_&255)<<7,_O),
						(/*_O='8A-adcAD    '*/)=>(F=(_=A+(F>>4&1)+D)>>4&16|(A^D^_)<<1&32|!(A=_&255)<<7,_O),
						(/*_O='8B-adcAE    '*/)=>(F=(_=A+(F>>4&1)+E)>>4&16|(A^E^_)<<1&32|!(A=_&255)<<7,_O),
						(/*_O='8C-adcAH    '*/)=>(F=(_=A+(F>>4&1)+H)>>4&16|(A^H^_)<<1&32|!(A=_&255)<<7,_O),
						(/*_O='8D-adcAL    '*/)=>(F=(_=A+(F>>4&1)+L)>>4&16|(A^L^_)<<1&32|!(A=_&255)<<7,_O),
						(/*_O='8E-adcAmHL  '*/)=>(F=(_=A+(F>>4&1)+RB(HL()))>>4&16|(A^_$^_)<<1&32|!(A=_&255)<<7,_O),
						(/*_O='8F-adcAA    '*/)=>(F=(_=A+(F>>4&1)+A)>>4&16|(A^A^_)<<1&32|!(A=_&255)<<7,_O),
						(/*_O='90-subAB    '*/)=>(F=(_=A-B)>>4&16|(A^B^_)<<1&32|64|!(A=_&255)<<7,_O),
						(/*_O='91-subAC    '*/)=>(F=(_=A-C)>>4&16|(A^C^_)<<1&32|64|!(A=_&255)<<7,_O),
						(/*_O='92-subAD    '*/)=>(F=(_=A-D)>>4&16|(A^D^_)<<1&32|64|!(A=_&255)<<7,_O),
						(/*_O='93-subAE    '*/)=>(F=(_=A-E)>>4&16|(A^E^_)<<1&32|64|!(A=_&255)<<7,_O),
						(/*_O='94-subAH    '*/)=>(F=(_=A-H)>>4&16|(A^H^_)<<1&32|64|!(A=_&255)<<7,_O),
						(/*_O='95-subAL    '*/)=>(F=(_=A-L)>>4&16|(A^L^_)<<1&32|64|!(A=_&255)<<7,_O),
						(/*_O='96-subAmHL  '*/)=>(F=(_=A-RB(HL()))>>4&16|(A^_$^_)<<1&32|64|!(A=_&255)<<7,_O),
						(/*_O='97-subAA    '*/)=>(F=(_=A-A)>>4&16|(A^A^_)<<1&32|64|!(A=_&255)<<7,_O),
						(/*_O='98-sbcAB    '*/)=>(F=(_=A-(F>>4&1)-B)>>4&16|(A^B^_)<<1&32|64|!(A=_&255)<<7,_O),
						(/*_O='99-sbcAC    '*/)=>(F=(_=A-(F>>4&1)-C)>>4&16|(A^C^_)<<1&32|64|!(A=_&255)<<7,_O),
						(/*_O='9A-sbcAD    '*/)=>(F=(_=A-(F>>4&1)-D)>>4&16|(A^D^_)<<1&32|64|!(A=_&255)<<7,_O),
						(/*_O='9B-sbcAE    '*/)=>(F=(_=A-(F>>4&1)-E)>>4&16|(A^E^_)<<1&32|64|!(A=_&255)<<7,_O),
						(/*_O='9C-sbcAH    '*/)=>(F=(_=A-(F>>4&1)-H)>>4&16|(A^H^_)<<1&32|64|!(A=_&255)<<7,_O),
						(/*_O='9D-sbcAL    '*/)=>(F=(_=A-(F>>4&1)-L)>>4&16|(A^L^_)<<1&32|64|!(A=_&255)<<7,_O),
						(/*_O='9E-sbcAmHL  '*/)=>(F=(_=A-(F>>4&1)-RB(HL()))>>4&16|(A^_$^_)<<1&32|64|!(A=_&255)<<7,_O),
						(/*_O='9F-sbcAA    '*/)=>(F=(_=A-(F>>4&1)-A)>>4&16|(A^A^_)<<1&32|64|!(A=_&255)<<7,_O),
						(/*_O='A0-andAB    '*/)=>(F=!(A&=B)<<7|32,_O),
						(/*_O='A1-andAC    '*/)=>(F=!(A&=C)<<7|32,_O),
						(/*_O='A2-andAD    '*/)=>(F=!(A&=D)<<7|32,_O),
						(/*_O='A3-andAE    '*/)=>(F=!(A&=E)<<7|32,_O),
						(/*_O='A4-andAH    '*/)=>(F=!(A&=H)<<7|32,_O),
						(/*_O='A5-andAL    '*/)=>(F=!(A&=L)<<7|32,_O),
						(/*_O='A6-andAmHL  '*/)=>(F=!(A&=RB(HL()))<<7|32,_O),
						(/*_O='A7-andAA    '*/)=>(F=!(A&=A)<<7|32,_O),
						(/*_O='A8-xorAB    '*/)=>(F=!(A^=B)<<7,_O),
						(/*_O='A9-xorAC    '*/)=>(F=!(A^=C)<<7,_O),
						(/*_O='AA-xorAD    '*/)=>(F=!(A^=D)<<7,_O),
						(/*_O='AB-xorAE    '*/)=>(F=!(A^=E)<<7,_O),
						(/*_O='AC-xorAH    '*/)=>(F=!(A^=H)<<7,_O),
						(/*_O='AD-xorAL    '*/)=>(F=!(A^=L)<<7,_O),
						(/*_O='AE-xorAmHL  '*/)=>(F=!(A^=RB(HL()))<<7,_O),
						(/*_O='AF-xorAA    '*/)=>(F=!(A^=A)<<7,_O),	
						(/*_O='B0-orAB     '*/)=>(F=!(A|=B)<<7,_O),
						(/*_O='B1-orAC     '*/)=>(F=!(A|=C)<<7,_O),
						(/*_O='B2-orAD     '*/)=>(F=!(A|=D)<<7,_O),
						(/*_O='B3-orAE     '*/)=>(F=!(A|=E)<<7,_O),
						(/*_O='B4-orAH     '*/)=>(F=!(A|=H)<<7,_O),
						(/*_O='B5-orAL     '*/)=>(F=!(A|=L)<<7,_O),
						(/*_O='B6-orAmHL   '*/)=>(F=!(A|=RB(HL()))<<7,_O),
						(/*_O='B7-orAA     '*/)=>(F=!(A|=A)<<7,_O),
						(/*_O='B8-cpAB     '*/)=>(F=(_=A-B)>>4&16|(A^B^_)<<1&32|64|!(_&255)<<7,_O),
						(/*_O='B9-cpAC     '*/)=>(F=(_=A-C)>>4&16|(A^C^_)<<1&32|64|!(_&255)<<7,_O),
						(/*_O='BA-cpAD     '*/)=>(F=(_=A-D)>>4&16|(A^D^_)<<1&32|64|!(_&255)<<7,_O),
						(/*_O='BB-cpAE     '*/)=>(F=(_=A-E)>>4&16|(A^E^_)<<1&32|64|!(_&255)<<7,_O),
						(/*_O='BC-cpAH     '*/)=>(F=(_=A-H)>>4&16|(A^H^_)<<1&32|64|!(_&255)<<7,_O),
						(/*_O='BD-cpAL     '*/)=>(F=(_=A-L)>>4&16|(A^L^_)<<1&32|64|!(_&255)<<7,_O),
						(/*_O='BE-cpmHL    '*/)=>(F=(_=A-RB(HL()))>>4&16|(A^_$^_)<<1&32|64|!(_&255)<<7,_O),
						(/*_O='BF-cpAA     '*/)=>(F=192,_O),
						(/*_O='C0-retNZ    '*/)=>(clk(1),F&128?0:PC=RW((SP+=2)-2),SP&=65535,_O),
						(/*_O='C1-popBC    '*/)=>(BC(RW((SP+=2)-2)),SP&=65535,_O),
						(/*_O='C2-jpNZnn   '*/)=>(RW(PC),PC=F&128?PC+2:(clk(1),_$),_O),
						(/*_O='C3-jpnn     '*/)=>(clk(1),PC=RW(PC),_O),
						(/*_O='C4-callNZnn '*/)=>(PC+=2,F&128?clk(2):(PC=RW(WW(SP-=2,PC)-2),SP&=65535,clk(1)),_O),
						(/*_O='C5-pshBC    '*/)=>(clk(1),WW(SP-=2,BC()),SP&=65535,_O),
						(/*_O='C6-addAn    '*/)=>(F=(_=A+RB(PC++))>>4&16|(A^_$^_)<<1&32|!(A=_&255)<<7,_O),
						(/*_O='C7-rst00    '*/)=>(clk(1),WW(SP-=2,PC),SP&=65535,PC=0,_O),
						(/*_O='C8-retZ     '*/)=>(clk(1),F&128?PC=RW((SP+=2)-2):0,SP&=65535,_O),
						(/*_O='C9-ret      '*/)=>(clk(1),PC=RW((SP+=2)-2),SP&=65535,_O),
						(/*_O='CA-jpZnn    '*/)=>(RW(PC),PC=F&128?(clk(1),_$):PC+2,_O),
						(/*_O='CB-prefix   '*/)=>(CB[RB(PC++)]()),
						(/*_O='CC-callZnn  '*/)=>(PC+=2,F&128?(PC=RW(WW(SP-=2,PC)-2),SP&=65535,clk(1)):clk(2),_O),
						(/*_O='CD-callnn   '*/)=>(clk(1),PC=RW(WW(SP-=2,PC+2)-2),SP&=65535,_O),
						(/*_O='CE-adcAn    '*/)=>(F=(_=A+(F>>4&1)+RB(PC++))>>4&16|(A^_$^_)<<1&32|!(A=_&255)<<7,_O),
						(/*_O='CF-rst08    '*/)=>(clk(1),WW(SP-=2,PC),SP&=65535,PC=8,_O),
						(/*_O='D0 retNC    '*/)=>(clk(1),F&16?0:PC=RW((SP+=2)-2),SP&=65535,_O),
						(/*_O='D1 popDE    '*/)=>(DE(RW((SP+=2)-2)),SP&=65535,_O),
						(/*_O='D2 jpNCnn   '*/)=>(RW(PC),PC=F&16?PC+2:(clk(1),_$),_O),
						(/*_O='D3          '*/)=>(_O),
						(/*_O='D4-callNCnn '*/)=>(PC+=2,F&16?clk(2):(PC=RW(WW(SP-=2,PC)-2),SP&=65535,clk(1)),_O),
						(/*_O='D5 pshDE    '*/)=>(clk(1),WW(SP-=2,DE()),SP&=65535,_O),
						(/*_O='D6 subAn    '*/)=>(F=(_=A-RB(PC++))>>4&16|(A^_$^_)<<1&32|64|!(A=_&255)<<7,_O),
						(/*_O='D7 rst10    '*/)=>(clk(1),WW(SP-=2,PC),SP&=65535,PC=16,_O),
						(/*_O='D8 retC     '*/)=>(clk(1),F&16?PC=RW((SP+=2)-2):0,SP&=65535,_O),
						(/*_O='D9 retI     '*/)=>(clk(1),PC=RW((SP+=2)-2),SP&=65535,ime=1,_O),
						(/*_O='DA jpCnn    '*/)=>(RW(PC),PC=F&16?(clk(1),_$):PC+2,_O),
						(/*_O='DB          '*/)=>(_O),
						(/*_O='DC-callCnn  '*/)=>(PC+=2,F&16?(PC=RW(WW(SP-=2,PC)-2),SP&=65535,clk(1)):clk(2),_O),
						(/*_O='DD          '*/)=>(_O),
						(/*_O='DE-sbcAn    '*/)=>(F=(_=A-(F>>4&1)-RB(PC++))>>4&16|(A^_$^_)<<1&32|64|!(A=_&255)<<7,_O),						
						(/*_O='DF-rst18    '*/)=>(clk(1),WW(SP-=2,PC),SP&=65535,PC=24,_O),
						(/*_O='E0-ldhmnA   '*/)=>(WB(0xFF00+RB(PC++),A),_O),
						(/*_O='E1-popHL    '*/)=>(HL(RW(SP)),SP=SP+2&65535,_O),
						(/*_O='E2-ldhmCA   '*/)=>(WB(0xFF00+C,A),_O),
						(/*_O='E3          '*/)=>(_O),
						(/*_O='E4          '*/)=>(_O),
						(/*_O='E5-pshHL    '*/)=>(clk(1),WW(SP-=2,HL()),SP&=65535,_O),
						(/*_O='E6-andAn    '*/)=>(F=!(A&=RB(PC++))<<7|32,_O),
						(/*_O='E7-rst20    '*/)=>(clk(1),WW(SP-=2,PC),SP&=65535,PC=32,_O),
						(/*_O='E8-addSPn   '*/)=>(F=($_=(SP=((_=SP)+($=RB(PC++)-2*(_$&128)))&65535)^_^$)>>4&16|$_<<1&32,_O),
						(/*_O='E9-jpHL     '*/)=>(PC=HL(),_O),
						(/*_O='EA-ldmnnA   '*/)=>(WB(RW(PC++),A),PC++,_O),
						(/*_O='EB          '*/)=>(_O),
						(/*_O='EC          '*/)=>(_O),
						(/*_O='ED          '*/)=>(_O),
						(/*_O='EE-xorAn    '*/)=>(F=!(A^=RB(PC++))<<7,_O),
						(/*_O='EF-rst28    '*/)=>(clk(1),WW(SP-=2,PC),SP&=65535,PC=40,_O),
						(/*_O='F0-ldhAmn   '*/)=>(A=RB(0xFF00+RB(PC++)),_O),
						(/*_O='F1-popAF    '*/)=>(AF(RW(SP)),SP=SP+2&65535,_O),
						(/*_O='F2-ldhAmC   '*/)=>(A=RB(0xFF00+C),_O),
						(/*_O='F3-dI       '*/)=>(ime=0,_O),
						(/*_O='F4          '*/)=>(_O),
						(/*_O='F5-pshAF    '*/)=>(clk(1),WW(SP-=2,AF()),SP&=65535,_O),
						(/*_O='F6-orAn     '*/)=>(F=!(A|=RB(PC++))<<7,_O),
						(/*_O='F7-rst30    '*/)=>(clk(1),WW(SP-=2,PC),SP&=65535,PC=48,_O),
						(/*_O='F8-ldHLSPn  '*/)=>(F=($_=HL(((_=SP)+($=RB(PC++)-2*(_$&128)))&65535)^_^$)>>4&16|$_<<1&32,_O),
						(/*_O='F9-ldSPHL   '*/)=>(SP=HL(),_O),
						(/*_O='FA-ldAmnn   '*/)=>(A=RB(RW(PC++)),PC++,_O),
						(/*_O='FB-eI       '*/)=>(ims=1,_O),
						(/*_O='FC          '*/)=>(_O),
						(/*_O='FD          '*/)=>(_O),
						(/*_O='FE-cpAn     '*/)=>(F=(_=A-RB(PC++))>>4&16|(A^_$^_)<<1&32|64|!(_&255)<<7,_O),
						(/*_O='FF-rst38    '*/)=>(clk(1),WW(SP-=2,PC),SP&=65535,PC=56,_O),
						(/*_O='INT V-Blank '*/)=>(clk(2+halt),itr[0]++,WW(SP-=2,PC),SP&=65535,PC=64,halt=ime=0,HRAM[0x10F]&=254,_O),
						(/*_O='INT LCDC    '*/)=>(clk(2+halt),itr[1]++,WW(SP-=2,PC),SP&=65535,PC=72,halt=ime=0,HRAM[0x10F]&=253,_O),
						(/*_O='INT Timer   '*/)=>(clk(2+halt),itr[2]++,WW(SP-=2,PC),SP&=65535,PC=80,halt=ime=0,HRAM[0x10F]&=251,_O),
						(/*_O='INT Serial  '*/)=>(clk(2+halt),itr[3]++,WW(SP-=2,PC),SP&=65535,PC=88,halt=ime=0,HRAM[0x10F]&=247,_O),
						(/*_O='INT Joypad  '*/)=>(clk(2+halt),itr[4]++,WW(SP-=2,PC),SP&=65535,PC=96,halt=ime=0,HRAM[0x10F]&=239,_O)],
						
					cyclog=new Array(128),logtrc=0,itr=[0,0,0,0,0],
					
					step=_=>//{cyclog[logtrc]=hex(PC-1,4)+" "+z80[_]();logtrc+=1;logtrc%=cyclog.length},
							this.stepe(_),

					cycles=_=>{let m,n,o;ms+=_;_=ms-mt;
						while(mt<ms){
							if(ime)ick(HRAM[0x10F]&HRAM[0x1FF])
							if(halt){m=mc //if halted
								if(HRAM[0x107]&4){clk(1) //if timer is running
									n=(3+HRAM[0x107]&3)*2+2
									HRAM[0x104]+=mc-(m>>6<<6)>>6
									if((o=(mc-(m>>n<<n)>>n)+HRAM[0x105])<256){
										HRAM[0x105]=o
									}else{
										if(~HRAM[0x10F]&4){
											HRAM[0x10F]|=4
											if(HRAM[0x1FF]&4){
												if(ime)step(0x102)
												halt=0;
											}
										}
										HRAM[0x105]=HRAM[0x106]-256+o
									}
								}else{clk(1)
									HRAM[0x104]+=mc-(m>>6<<6)>>6
								}
								if(HRAM[0x10F]&HRAM[0x1FF]){halt=0,clk(1),step(RB(PC))}
							}
							if(mt<ms){
								while(mt<ms&&!halt){m=mc;
									step(RB(PC++));PC&=65535;
									HRAM[0x104]+=mc-(m>>6<<6)>>6
									if(HRAM[0x107]&4){
										n=(3+HRAM[0x107]&3)*2+2
										if((o=(mc-(m>>n<<n)>>n)+HRAM[0x105])<256){
											HRAM[0x105]=o
										}else{
											HRAM[0x105]=HRAM[0x106]-255+o
											if(~HRAM[0x10F]&4){
												HRAM[0x10F]|=4
												if(HRAM[0x1FF]&4){halt=0;
												if(ime){step(0x102);
											}}}
										}
									}
									mc-(m>>10<<10)>>10?snd.update():0
								}
							}
						}
					},
					
					reset=()=>{skipBIOS=1
						if(snd){snd.A.vol(0);snd.B.vol(0);snd.C.vol(0);snd.D.vol(0);}
					let	j=CROM.length;
						keys=255;
						ime=csm=1;
						PC=SP=ms=mc=mt=0;
						A=B=C=D=E=F=H=L=0;
						bs=vr=halt=stop=0;
						if(!BIOS)BIOS=new Uint8Array(0x100);
						HRAM=new Uint8Array(0x200);
						WRAM=new Uint8Array(0x2000);
						if(!ERAM)ERAM=new Uint8Array(0x8000);
						VRAM=new Uint8Array(0x2000);
						for(var i=0;i<256;i++)BIOS[i]=internalBiosRom[i];
						if(skipBIOS){bs=1;AF(0x01B0);BC(0x0013);DE(0x00D8);HL(0x014D);
							HRAM[0x149]=HRAM[0x120]=HRAM[0x148]=HRAM[0x11B]=0xFF;
							HRAM[0x111]=HRAM[0x114]=HRAM[0x123]=HRAM[0x11E]=HRAM[0x119]=0xBF;
							HRAM[0x110]=0x80;HRAM[0x112]=0xF3;HRAM[0x116]=0x3F;HRAM[0x11C]=0x9F;
							HRAM[0x11A]=0x7F;HRAM[0x124]=0x77;HRAM[0x125]=0xF3;HRAM[0x126]=0xF1;
							HRAM[0x140]=0x91;HRAM[0x147]=0xFC;SP=0xFFFE;PC=0x100;
						}else{
							for(var i=0;i<8192;i++){
								VRAM[i]=Math.random()*256&255;
								WRAM[i]=Math.random()*256&255;}
						}
						mbc.tp=CROM[0x147]
						mbc.md=0
						mbc.cs=0
						mbc.es=0
						mbc.en=0
						console.log("Cartridge Type: "+cartinfo[mbc.tp])
					},
					Gctx=document.getElementById(GBscr).getContext("2d"),
					Bctx=document.getElementById(BGscr).getContext("2d"),
					Gslf=Gctx.createImageData(160,144),
					Bslf=Bctx.createImageData(256,256);
					CROM=internalCartRom;
				//  private End
			
			//	public Start
				this.opt	=	{
					viewbgmap	: false
				}
				this.stepe  =_=>(z80[_](),ime?(ick(HRAM[0x10F]&HRAM[0x1FF]),ims=0):ims>0?ime=1:0);
				
				//this.stepe=_=>{try{(z80[_](),ime?(ick(HRAM[0x10F]&HRAM[0x1FF]),ims=0):ims>0?ime=1:0)}catch(e){console.log(_,hex(PC,4))}};
				this.getPC  =_=>PC;
				this.frame	=___=>{
					let i,j=new Uint8Array(10),k,l,m,n,o,x,y,z,a,b,c,f=0,
						d=new Uint8Array(176),e,h,g=Gslf.data,mtc=mt;
						snd.ct=snd.ctx.currentTime;
						snd.mt=mt;
					
					let hlines = new Uint32Array(256), blnd=1;
					if(this.opt.enabmblur)blnd=0.25
					//  d= [0:sparrrcc,1:sparrrcc,2:sparrrcc,...]
					//     s= 1:sprite
					//	   p= 1:priority
					//     a= 1:transparent
					//	   r= palette reference
					//     c= pixel palette value
					
					while(___-- >0){let kkkk=___;
						if(this.opt.enabmblur)___=f=0
						if(HRAM[0x140]&128){
							if((HRAM[0x141]&16)&&(HRAM[0x1FF]&2))
								if(halt)if(~HRAM[0x10F]&2)(clk(1),halt=0);
						// Entering V-Blank, enable V-Blank Interrupt request,
							HRAM[0x141]&=0xFC; // If LCD is on.
							HRAM[0x10F]|=1|HRAM[0x141]>>3&2|HRAM[0x141]>>4&2}
						
						hlines.fill(0,0);
					let t=ms
						for(l=144;l<153;l++,HRAM[0x144]++){cycles(4);   // During V-Blank
							if(m=HRAM[0x145]==HRAM[0x144]){
								if(HRAM[0x140]&128){
									if((HRAM[0x141]&64)&&(HRAM[0x1FF]&2))
										if(halt)if(~HRAM[0x10F]&2)(clk(1),halt=0);
									HRAM[0x10F]|=HRAM[0x141]>>5&2;}}
							// LCDC LYC==LY Interrupt request
							HRAM[0x141]=HRAM[0x141]&0x78|4*m|1;
							HRAM[0x140]&128?0:HRAM[0x141]&=0xFC;
							cycles(456-ms+t);t+=456;
						} //Update LCD stat
							
						cycles(4);
						if(m=HRAM[0x145]==HRAM[0x144]){
							if(HRAM[0x140]&128){
								if((HRAM[0x141]&64)&&(HRAM[0x1FF]&2))
									if(halt)if(~HRAM[0x10F]&2)(clk(1),halt=0);
								HRAM[0x10F]|=HRAM[0x141]>>5&2;}}
						// LCDC LYC==LY Interrupt request
						HRAM[0x141]=HRAM[0x141]&0x78|4*m|1;
						HRAM[0x140]&128?0:HRAM[0x141]&=0xFC;
						HRAM[0x144]=0;cycles(8);
						
						if(m=HRAM[0x145]==HRAM[0x144]){
							if(HRAM[0x140]&128){
								if((HRAM[0x141]&64)&&(HRAM[0x1FF]&2))
									if(halt)if(~HRAM[0x10F]&2)(clk(1),halt=0);
								HRAM[0x10F]|=HRAM[0x141]>>5&2;}}
						// LCDC LYC==LY Interrupt request
						HRAM[0x141]=HRAM[0x141]&0x78|4*m|1;
						HRAM[0x140]&128?0:HRAM[0x141]&=0xFC;
						cycles(456-ms+t);t+=456;
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						
						

						let wl=0
							for(HRAM[0x144]=l=0;l<144;l++,HRAM[0x144]++){ // During OAM search
								
								if(m=HRAM[0x145]==HRAM[0x144]){
									if(HRAM[0x140]&128){
										if((HRAM[0x141]&64)&&(HRAM[0x1FF]&2))
											if(halt)if(~HRAM[0x10F]&2)(clk(1),halt=0)
										HRAM[0x10F]|=HRAM[0x141]>>5&2;
									}
								} // LCDC LYC==LY Interrupt request
								if(HRAM[0x140]&128){
									if((HRAM[0x141]&32)&&(HRAM[0x1FF]&2))
										if(halt)if(~HRAM[0x10F]&2)(clk(1),halt=0)
									HRAM[0x10F]|=HRAM[0x141]>>4&2; // LCDC OAM Interrupt
								}
								HRAM[0x141]=HRAM[0x141]&0xF8|4*m|2;
								HRAM[0x140]&128?0:HRAM[0x141]&=0xFC;cycles(76) // Update LCD stat
								
								if(HRAM[0x140]&128)if(/*___==0*/true)if(HRAM[0x140]&2) // Case sprite drawing is on,
									for(i=k=0,o=HRAM[0x140]&4?0:-8;k<160;k+=4) // scan for sprites
										if(l-(n=HRAM[k])<o&&l+17>n)j[i++]=k    // through OAM 
								x=HRAM[0x143];c=-(x&7)-8;x>>=3;cycles(16+c)   // BG x-scroll align
								HRAM[0x141]&=0xFC;if(HRAM[0x140]&128)HRAM[0x141]|=3;
								
								hlines[l+HRAM[0x142]&255]=16*HRAM[0x143]|1|HRAM[0x140]>>2&2|HRAM[0x140]>>2&4|HRAM[0x147]<<12;
								// During Pixel Transfer
								let wy=HRAM[0x140]&32?HRAM[0x14A]:144,wx=wy>l?176:HRAM[0x14B]+1
								
								if(___>0||HRAM[0x140]<128){  //For Background
									if(wx<168){cycles(wx-16-c)}else{cycles(152-c)}
								}else{	for(k=16+c;k<wx&&k<168;){
										m=HRAM[0x140];n=HRAM[0x141];o=m&8?0x1C00:0x1800
										y=HRAM[0x142]+l&255;z=VRAM[o|x++|y>>3<<5]
										z=(m&16?z:!(z>>7)<<8|z)<<4|y<<1&14
										a=VRAM[z];b=VRAM[z|1];z=HRAM[0x147];x&=31;
										for(let y=2;y;y--){cycles(4);for(let i=k+4;k<i;k++){ 
										d[k]=!(o=a>>7|b>>6&2)<<5|z>>o+o&3;a=a+a&255;b=b+b&255}}}}
								
								if(k>=wx){cycles(4); //For Window
									if(___>0||HRAM[0x140]<128){cycles(168-wx)}else{for(k=wx,x=0;k<168;){  
										m=HRAM[0x140];n=HRAM[0x141];o=m&64?0x1C00:0x1800;
										z=VRAM[o|x++|wl>>3<<5];z=(m&16?z:!(z>>7)<<8|z)<<4|wl<<1&14
										a=VRAM[z];b=VRAM[z|1];z=HRAM[0x147];x&=31;
										for(let y=2;y;y--){cycles(4);for(let i=k+4;k<i;k++){ 
										d[k]=!(o=a>>7|b>>6&2)<<5|z>>o+o&3|4;a=a+a&255;b=b+b&255}}}wl++}}
								
								if(___==0&&HRAM[0x140]>127){ // Sprite mixing
									for(;i>0;){k=j[--i];y=l-HRAM[k]+16;
										x=HRAM[k+1];n=HRAM[k+3];h=136+(n>>2&4)
										if(n&64)y=m&4?15-y:7-y;z=HRAM[k+2]<<4|y<<1;                  
										a=VRAM[z];b=VRAM[z|1];z=HRAM[0x148|n>>4&1];                 
										((_a,_b)=>{if(n&128){ // Apply sprite to scanline
											for(y=x+8;x<y;x++){n=d[x];if(o=_a()){if(n&128){
											d[x]=h|z>>o+o&3}else{if(n&32)d[x]=h|z>>o+o&3
											}}_b()}}else{for(y=x+8;x<y;x++){n=d[x];if(o=_a()){
											if(n&128){d[x]=h|z>>o+o&3}else{if(n&64){if(o&32)
											d[x]=h|z>>o+o&3}else{d[x]=h|z>>o+o&3}}}_b()}}
										})(n&32?(_=>(a&1|b<<1&2)):(_=>(a>>7|b>>6&2)),n&32?
										(_=>(a>>=1,b>>=1)):(_=>(a=a+a&255,b=b+b&255)))}
									for(k=8;k<168;k++){
										x=gbpal[d[k]>>2&3][d[k]&3];  // Apply scanline to canvas
										g[f]+=(x[0]-g[f++])*blnd;
										g[f]+=(x[1]-g[f++])*blnd;
										g[f]+=(x[2]-g[f++])*blnd;
										g[f]+=(x[3]-g[f++])*blnd}
								}
								if(HRAM[0x140]&128){
									if((HRAM[0x141]&8)&&(HRAM[0x1FF]&2))
										if(halt)if(~HRAM[0x10F]&2)(clk(1),halt=0)
									HRAM[0x10F]|=HRAM[0x141]>>2&2  // LCDC H-Blank Interrupt
									HRAM[0x141]=HRAM[0x141]&0xFC;}
								cycles(456-ms+t);t+=456 // During H-Blank
								
							}___=kkkk;Gslf.data=g;
							if(___==0){Gctx.putImageData(Gslf,0,0);
								if(this.opt.viewbgmap){
									for(f=l=0,g=Bslf.data;l<256;l++)for(x=k=0;k<256;){  //For BG Map
										m=HRAM[0x140];n=HRAM[0x141];
										o=(hlines[l]?hlines[l]&2:m&8)?0x1C00:0x1800
										y=l&255;z=VRAM[o|x++|y>>3<<5]
										z=((hlines[l]?hlines[l]&4:m&16)?z:!(z>>7)<<8|z)<<4|y<<1&14
										
										a=VRAM[z];b=VRAM[z|1];
										z=hlines[l]?hlines[l]>>12&255:HRAM[0x147];
										x&=31;
										for(let i=k+8;k<i;k++){
										let y=(!(o=a>>7|b>>6&2)<<5|z>>o+o&3)&3;
//										if((l-HRAM[0x142]&255)<144&&(l-HRAM[0x142]&255)>=0)
//											if((k-HRAM[0x143]&255)<160&&(k-HRAM[0x143]&255)>=0)
//												if(HRAM[0x142]==l||(HRAM[0x142]+143&255)==l||
//												HRAM[0x143]==k||(HRAM[0x143]+159&255)==k)
//														y^=3;
										m=gbpal[0][y^3]
										y=gbpal[0][y];n=0.60;
										if((o=hlines[l])&1)
											if((k-(o>>=4)&255)<160)
												if((k-o&255)>=0)n=1;
										g[f++]=m[0]+(y[0]-m[0])*n;
										g[f++]=m[1]+(y[1]-m[1])*n;
										g[f++]=m[2]+(y[2]-m[2])*n;
										g[f++]=m[3]+(y[3]-m[3])*n
										a=a+a&255;b=b+b&255
										}}
									
									Bctx.putImageData(Bslf,0,0)
								}
							}
						
					}
					return mt-mtc
				}
				
					
					//snd.D.buf(snd.nwv[HRAM[0x122]>>3&1])
					//snd.A.vol((HRAM[0x112]>>4)/16)
					//snd.B.vol((HRAM[0x117]>>4)/16)
					//snd.D.vol((HRAM[0x121]>>4)/16)
					//snd.C.vol(HRAM[0x11A]&128?(_=HRAM[0x11C]>>5&3)?2/(1<<_):0:0)
					//snd.A.frq(131072/(2048-(HRAM[0x113]+(HRAM[0x114]&7)*256)))
					//snd.B.frq(131072/(2048-(HRAM[0x118]+(HRAM[0x119]&7)*256)))
					//snd.C.frq(131072/(2048-(HRAM[0x11D]+(HRAM[0x11E]&7)*256)))
					//snd.D.frq(32768/((_=HRAM[0x122])&3?_&3:0.5)/(2<<(_>>4)))
					////if(HRAM[0x114]&64){//Sound A by length
					////	a=parseInt((mt-(parseInt(snd.t/4096)*4096))/4096)
					////	x=(HRAM[0x111]&0x3F)-a;if(x<1){HRAM[0x112]&=15;x=0}
					////	HRAM[0x111]&=192;HRAM[0x111]|=x}
					//if(x=HRAM[0x112]&7){//Sound A Envelope
					//	a=parseInt((mt-(parseInt(snd.t/65536/x)*x*65536))/65536/x);
					//	x=HRAM[0x112]>>4;x+=HRAM[0x112]&8?a:-a;x=x<0?0:x;x=x>15?15:x
					//	HRAM[0x112]&=15;HRAM[0x112]|=x<<4}
					//	
					////if(HRAM[0x119]&64){//Sound D by length
					////	a=parseInt((mt-(parseInt(snd.t/4096)*4096))/4096)
					////	x=(HRAM[0x116]&0x3F)-a;if(x<1){HRAM[0x117]&=15;x=0}
					////	HRAM[0x116]&=192;HRAM[0x116]|=x}
					//if(x=HRAM[0x117]&7){//Sound B Envelope
					//	a=parseInt((mt-(parseInt(snd.t/65536/x)*x*65536))/65536/x);
					//	x=HRAM[0x117]>>4;x+=HRAM[0x117]&8?a:-a;x=x<0?0:x;x=x>15?15:x
					//	HRAM[0x117]&=15;HRAM[0x117]|=x<<4}
					//
					////if(HRAM[0x123]&64){//Sound D by length
					////	a=parseInt((mt-(parseInt(snd.t/4096)*4096))/4096)
					////	x=(HRAM[0x120]&0x3F)-a;if(x<1){HRAM[0x121]&=15;x=0}
					////	HRAM[0x120]&=192;HRAM[0x120]|=x}
					//if(x=HRAM[0x121]&7){//Sound D Envelope
					//	a=parseInt((mt-(parseInt(snd.t/65536/x)*x*65536))/65536/x);
					//	x=HRAM[0x121]>>4;x+=HRAM[0x121]&8?a:-a;x=x<0?0:x;x=x>15?15:x
					//	HRAM[0x121]&=15;HRAM[0x121]|=x<<4}
				this.keydw= e=>{switch(e.keyCode){
								case 39: keys &= 0xEF; break
								case 37: keys &= 0xDF; break
								case 38: keys &= 0xBF; break
								case 40: keys &= 0x7F; break
								case 65: keys &= 0xFE; break
								case 83: keys &= 0xFD; break
								case 32: keys &= 0xFB; break
								case 13: keys &= 0xF7; break}
								if([37,38,39,40].indexOf(e.keyCode)>=0)
									e.preventDefault()}
				this.keyup= e=>{switch(e.keyCode){
								case 39: keys |= 0x10; break
								case 37: keys |= 0x20; break
								case 38: keys |= 0x40; break
								case 40: keys |= 0x80; break
								case 65: keys |= 0x01; break
								case 83: keys |= 0x02; break
								case 32: keys |= 0x04; break
								case 13: keys |= 0x08; break}}
				this.getRegs=()=>({r8:[A,F,B,C,D,E,H,L],r16:[AF(),BC(),DE(),HL(),SP,PC],
					clk:[mc,mt,keys,ms,itr,halt,ime,HRAM[0x1FF],HRAM[0x10F],mbc.cs]}),
				this.getMem=($,_)=>{let l=new Uint8Array(_)
					for(let i=$,j=$+_&65535,k=0;i!=j;i=++i&65535,k++)
						l[k]=rb[i>>12&15](i&0xFFF);return l}
				this.setMem=(_,$)=>(wb[_>>12&15](_&0xFFF,$))
				this.setCROM=_=>CROM=_?_:internalCartRom
				this.getLog=()=>{let k=logtrc,j=cyclog.length,i=[]; do{i.push(cyclog[k++]);k=(k+j)%j}while(k!=logtrc); return i}
				this.reset=reset
				this.cycle=(_=-1)=>{var i="";if(_<0){i+=hex(PC,4)+" "+z80[RB(PC++)]();ms=mt
				}else{for(ms+=_;mt<ms;)i+=hex(PC,4)+" "+z80[RB(PC++)]()+"\n";}console.log(i);console.log(state())},
				this.cycles=_=>(cycles(_),console.log(state()))
				this.runbreak=_=>{for(var z=0;(PC!=_)&&(z<10000);z++)z80[RB(PC++)]();ms=mt;console.log(z+" instructions exceeded.\n"+state())}
				this.step=step;this.gbpal=gbpal;
				reset()
				this.HRAM=HRAM
				this.PC=(_=-1)=>(_<0?PC:PC=_)
				this.itr=itr
				this.sndStart=_=>{this.snd=snd=new Snd()}
	}
	</script>
	<script name="rAF">
	//	https://gist.github.com/addyosmani/5434533
		window.requestAnimationFrame = (()=>
				window.requestAnimationFrame || window.webkitRequestAnimationFrame ||
				window.mozRequestAnimationFrame || window.msRequestAnimationFrame ||
				window.oRequestAnimationFrame || (f=>window.setTimeout(f,1000/60)))();
		var limitLoop = function (fn, fps) {
			var then = new Date().getTime();
			var interval = 1000 / fps;
			return (function loop(time){
				Mloop = requestAnimationFrame(loop);
				var now = new Date().getTime();
				var delta = now - then;
				if (delta => interval) {
					var skip=Math.min(6,
						Math.floor(delta/interval))
					then = now - (delta % interval)
					fn(skip)
				}
			}(0));
		};
	</script>
	<script name="GBMisc">
	var	hex		=(k,l)=>(k.toString(16).toUpperCase().padStart(l,'0')),
		HEX		=(k,l)=>(k.reduce(($,_)=>($+=hex(_,l)),"")
		)//,

	</script>
	<script name="GBMain">
		var sndgA,sndoA,sndgB,sndoB,sndgC,sndoC,pal=[],GBdemos,
			bgtiles=document.getElementsByName("bgtiles")[0],
			mblur=document.getElementsByName("mblur")[0],
			dlist=document.getElementById("demolist"),
		    GBemu = new GB("GBScr","BGScr"),Mloop//console.log(state())	//57344
			pal[0]=document.getElementsByName("bkgpalval");
			pal[1]=document.getElementsByName("winpalval");
			pal[2]=document.getElementsByName("ob0palval");
			pal[3]=document.getElementsByName("ob1palval");
			for(var i=0;i<4;i++)
				for(var j=0;j<4;j++){
					var k=HEX(GBemu.gbpal[i][j],2);
					var l=pal[i][j]; l.value=k;
					var m=parseInt(parseInt("0x"+k)/256)
						l.style.backgroundColor="#"+hex(m,6);
						l.style.backgroundColor="#"+k;
				}
			
			if(Array.isArray(GBdemos))
				for (var i=0; i<GBdemos.length; i++) {
					dlist.innerHTML+="<option value="+i+">"+GBdemos[i].name+"</option>"
				}
		var	setpal = function(i,j){
			var l=pal[i][j], k=parseInt("0x"+l.value),
				m=parseInt(k/256);l.style.backgroundColor="#"+hex(m,6);
				l.style.backgroundColor="#"+hex(k,8); l.value=hex(k,8);
				GBemu.gbpal[i][j]=[k>>24&255,k>>16&255,k>>8&255,k&255];
		}
		
		var bgmapview = function() {
			GBemu.opt.viewbgmap=bgtiles.checked }
			
		var mblurenab = function() {
			GBemu.opt.enabmblur=mblur.checked }
		
		var state =()=>{ let b = GBemu.getRegs(); a=b.r16; c=b.clk; return (
				"PC: "+hex(a[5],4)+" - SP: "+hex(a[4],4)+
				"\nAF: "+hex(a[0],4)+" - BC: "+hex(a[1],4)+
				"\nDE: "+hex(a[2],4)+" - HL: "+hex(a[3],4)+
				"\nmc: "+hex(c[0],15)+"\nmt: "+hex(c[1],15)+
				"\nms: "+hex(c[3],15)+
				"\nIntrnl Dv: "+
				GBemu.getMem(0xFF04,4).reduce(($,_)=>($+=hex(_,2)),"")+
				"\nIE: "+hex(c[7],2)+" IF: "+hex(c[8],2)+
				" halt: "+hex(c[5],1)+" ime: "+hex(c[6],1)+
				"\nINTrpt: "+(c[4]).reduce(($,_)=>($+=hex(_&255,2)+" "),"")+
				"\nJPD: "+hex(c[2],2))+"  - MBC: "+hex(c[9]>>8,4)//+"  - OAM: \n"+
				//GBemu.getMem(0xFE00,16).reduce(($,_)=>($+=hex(_,2)),"")+"\n"+
				//GBemu.getMem(0xFE10,16).reduce(($,_)=>($+=hex(_,2)),"")+"\n"+
				//GBemu.getMem(0xFE20,16).reduce(($,_)=>($+=hex(_,2)),"")+"\n"+
				//GBemu.getMem(0xFE30,16).reduce(($,_)=>($+=hex(_,2)),"")+"\n"+
				//GBemu.getMem(0xFE40,16).reduce(($,_)=>($+=hex(_,2)),"")+"\n"+
				//GBemu.getMem(0xFE50,16).reduce(($,_)=>($+=hex(_,2)),"")+"\n"+
				//GBemu.getMem(0xFE60,16).reduce(($,_)=>($+=hex(_,2)),"")+"\n"+
				//GBemu.getMem(0xFE70,16).reduce(($,_)=>($+=hex(_,2)),"")+"\n"+
				//GBemu.getMem(0xFE80,16).reduce(($,_)=>($+=hex(_,2)),"")+"\n"+
				/*GBemu.getMem(0xFE90,16).reduce(($,_)=>($+=hex(_,2)),"")*/+"\nSq A "+
				HEX(GBemu.getMem(0xFF10, 5),2)+"  Sq B "+
				HEX(GBemu.getMem(0xFF15, 5),2)+"\nWave "+
				HEX(GBemu.getMem(0xFF1A, 5),2)+"  Nois "+
				HEX(GBemu.getMem(0xFF1F, 5),2)+"\n"+
				HEX(GBemu.getMem(0xFF30,16),2)
				}
			
			Gctx=document.getElementById("GBScr").getContext("2d")
			Gctx.fillStyle="#808080",Gctx.fillRect(0,0,160,144)
			RgLg=document.getElementById("Regs")
			RgLg.innerText=state()
			CFr=document.getElementById("cfr")
			bgmapview();mblurenab();
			
		var	play=_=>{
			var a = document.getElementById("play")
			if(Mloop){
				window.cancelAnimationFrame(Mloop);Mloop=undefined
				a.innerText="Play"
				GBemu.snd.off()
			}else{
				if(!GBemu.snd)GBemu.sndStart()
				GBemu.snd.on()
				Mloop=limitLoop((_=>{CFr.innerText="CpF: "+
					GBemu.frame(_).toString().padStart(6," ")+" | " + _ + " frames"
					,RgLg.innerText=state()}),60)
				a.innerText="Stop"
			}
		}
		
		var reset=_=>GBemu.reset()
		
		function load() {
			var	nlst = parseInt(dlist.value);
			if(nlst<0){
				document.getElementById("getfile").click()
			}else{
				GBemu.setCROM(atob(GBdemos[nlst].data).split('').map(_=>_.charCodeAt(0)));
				GBemu.reset();
			}
		}
		
		function gload() {
			var file = document.getElementById("getfile").files[0];
			var reader = new FileReader();
		
			function actuallyLoad() {var buff = reader.result;
				var bytes = new Uint8Array(buff);
				GBemu.setCROM(bytes);GBemu.reset()
				//var binary = new Uint8Array(l=bytes.length);
				//for(z=0;z<l;z++)binary[z]=bytes[z]
				}
		
			reader.onload = actuallyLoad;
			reader.readAsArrayBuffer(file);
		}
		
		window.onkeydown = GBemu.keydw;
		window.onkeyup   = GBemu.keyup;
	</script>
	</body>
</html>